<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Kiểm kho T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
    }
    h1 {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .row > * {
      flex: 1;
      min-width: 120px;
    }
    input, button {
      padding: 8px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .barcode-input {
      font-size: 16px;
      font-weight: bold;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .highlight {
      background: #fff3cd !important;
    }
  </style>
</head>
<body>
  <h1>App kiểm kho (beta)</h1>

  <div class="row">
    <div>
      <label>Mã vạch (quét hoặc gõ):</label>
      <input id="barcodeInput" class="barcode-input" autofocus />
      <div class="small">Đầu đọc: chỉ cần quét, thường sẽ tự Enter.</div>
    </div>
    <div>
      <label>Tên sản phẩm:</label>
      <input id="nameInput" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>Số lượng:</label>
      <input id="qtyInput" type="number" value="1" min="0" />
    </div>
    <div>
      <label>Vị trí / Kệ:</label>
      <input id="locationInput" />
    </div>
    <div>
      <label>Ghi chú:</label>
      <input id="noteInput" />
    </div>
  </div>

  <div class="row">
    <button id="saveBtn">Lưu / Cập nhật (Enter)</button>
    <button id="resetBtn">Xóa form</button>
  </div>

  <div class="row">
    <div>
      <label>Import CSV hiện có:</label>
      <input id="csvFileInput" type="file" accept=".csv" />
    </div>
    <button id="exportBtn">Export CSV kiểm kho</button>
  </div>

  <div class="small">
    Dữ liệu tạm cũng được lưu trong trình duyệt (localStorage) để lỡ tải lại trang không mất hết.
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Mã vạch</th>
        <th>Tên sản phẩm</th>
        <th>Số lượng</th>
        <th>Vị trí</th>
        <th>Ghi chú</th>
        <th>Cập nhật lúc</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <script>
    const barcodeInput = document.getElementById('barcodeInput');
    const nameInput = document.getElementById('nameInput');
    const qtyInput = document.getElementById('qtyInput');
    const locationInput = document.getElementById('locationInput');
    const noteInput = document.getElementById('noteInput');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const csvFileInput = document.getElementById('csvFileInput');
    const exportBtn = document.getElementById('exportBtn');
    const itemsBody = document.getElementById('itemsBody');

    let items = []; // { barcode, name, qty, location, note, updated_at }

    function loadFromLocalStorage() {
      const raw = localStorage.getItem('inventoryItems');
      if (!raw) return;
      try {
        items = JSON.parse(raw);
        renderTable();
      } catch (e) {
        console.error('LS parse error', e);
      }
    }

    function saveToLocalStorage() {
      localStorage.setItem('inventoryItems', JSON.stringify(items));
    }

    function renderTable(highlightBarcode = null) {
      itemsBody.innerHTML = '';
      items.forEach((item, idx) => {
        const tr = document.createElement('tr');
        if (highlightBarcode && item.barcode === highlightBarcode) {
          tr.classList.add('highlight');
        }

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${item.barcode || ''}</td>
          <td>${item.name || ''}</td>
          <td>${item.qty ?? ''}</td>
          <td>${item.location || ''}</td>
          <td>${item.note || ''}</td>
          <td>${item.updated_at || ''}</td>
        `;

        tr.addEventListener('click', () => {
          // click 1 dòng để load lại lên form
          barcodeInput.value = item.barcode || '';
          nameInput.value = item.name || '';
          qtyInput.value = item.qty ?? 0;
          locationInput.value = item.location || '';
          noteInput.value = item.note || '';
          barcodeInput.focus();
          barcodeInput.select();
        });

        itemsBody.appendChild(tr);
      });
    }

    function nowString() {
      const d = new Date();
      const pad = (n) => (n < 10 ? '0' + n : n);
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} `
           + `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function upsertItemFromForm() {
      const barcode = (barcodeInput.value || '').trim();
      if (!barcode) {
        alert('Chưa có mã vạch');
        barcodeInput.focus();
        return;
      }

      let name = (nameInput.value || '').trim();
      let qty = parseInt(qtyInput.value, 10);
      if (isNaN(qty)) qty = 0;
      const location = (locationInput.value || '').trim();
      const note = (noteInput.value || '').trim();

      const existing = items.find((i) => i.barcode === barcode);

      if (existing) {
        // Nếu tồn tại: nếu không sửa tay qty thì mặc định +1
        if (name) existing.name = name;
        if (location) existing.location = location;
        if (note) existing.note = note;

        if ((qtyInput.value || '').trim() === '') {
          existing.qty = (existing.qty || 0) + 1;
        } else {
          existing.qty = qty;
        }

        existing.updated_at = nowString();
      } else {
        const newItem = {
          barcode,
          name,
          qty: qty || 1,
          location,
          note,
          updated_at: nowString(),
        };
        items.push(newItem);
      }

      saveToLocalStorage();
      renderTable(barcode);

      // reset form nhẹ cho quét tiếp
      qtyInput.value = '';
      nameInput.value = name; // giữ lại tên nếu vừa nhập
      locationInput.value = location;
      noteInput.value = note;
      barcodeInput.value = '';
      barcodeInput.focus();
    }

    function resetForm() {
      barcodeInput.value = '';
      nameInput.value = '';
      qtyInput.value = '1';
      locationInput.value = '';
      noteInput.value = '';
      barcodeInput.focus();
    }

    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter((l) => l.trim() !== '');
      if (lines.length === 0) return;
      const header = lines[0].split(',');
      const getIdx = (name) => header.indexOf(name);

      const idxBarcode = getIdx('barcode');
      const idxName = getIdx('name');
      const idxQty = getIdx('qty');
      const idxLocation = getIdx('location');
      const idxNote = getIdx('note');
      const idxUpdated = getIdx('updated_at');

      items = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        if (!cols.length) continue;
        const barcode = cols[idxBarcode] || '';
        if (!barcode) continue;
        items.push({
          barcode: barcode,
          name: cols[idxName] || '',
          qty: cols[idxQty] ? parseInt(cols[idxQty], 10) || 0 : 0,
          location: idxLocation >= 0 ? (cols[idxLocation] || '') : '',
          note: idxNote >= 0 ? (cols[idxNote] || '') : '',
          updated_at: idxUpdated >= 0 ? (cols[idxUpdated] || '') : '',
        });
      }

      saveToLocalStorage();
      renderTable();
      alert('Import CSV xong: ' + items.length + ' sản phẩm');
    }

    function exportCsv() {
      if (!items.length) {
        alert('Chưa có dữ liệu để export');
        return;
      }
      const header = 'barcode,name,qty,location,note,updated_at';
      const lines = [header];

      items.forEach((item) => {
        const row = [
          item.barcode || '',
          (item.name || '').replace(/,/g, ' '),
          item.qty ?? 0,
          (item.location || '').replace(/,/g, ' '),
          (item.note || '').replace(/,/g, ' '),
          item.updated_at || '',
        ];
        lines.push(row.join(','));
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hang-kiem-kho.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Events
    saveBtn.addEventListener('click', upsertItemFromForm);
    resetBtn.addEventListener('click', resetForm);

    barcodeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        // Enter trực tiếp lưu
        upsertItemFromForm();
      }
    });

    csvFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        parseCsv(event.target.result);
      };
      reader.readAsText(file, 'utf-8');
    });

    exportBtn.addEventListener('click', exportCsv);

    loadFromLocalStorage();
    barcodeInput.focus();
  </script>
</body>
</html>
