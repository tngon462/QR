<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Kiểm kho T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
    }
    h1 {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .field {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }
    label {
      font-size: 13px;
      margin-bottom: 2px;
    }
    input, select, button {
      padding: 8px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .barcode-input {
      font-size: 16px;
      font-weight: bold;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .highlight {
      background: #fff3cd !important;
    }
  </style>
</head>
<body>
  <h1>App kiểm kho (beta)</h1>

  <!-- Form nhập -->
  <div class="field">
    <label>Mã vạch (quét hoặc gõ):</label>
    <input id="barcodeInput" class="barcode-input" autofocus />
    <div class="small">
      Đầu đọc: quét xong thường sẽ tự Enter.  
      Nếu mã đã có → sẽ tự nhảy đến dòng đó. Nếu chưa có → giữ nguyên để nhập tiếp.
    </div>
  </div>

  <div class="field">
    <label>Tên sản phẩm:</label>
    <input id="nameInput" />
  </div>

  <div class="field">
    <label>Danh mục:</label>
    <select id="categoryInput">
      <option value="">-- Chọn danh mục --</option>
      <!-- Sếp muốn thêm/bớt danh mục chỉ cần sửa đoạn option này -->
      <option value="Đồ khô">Đồ khô</option>
      <option value="Đông lạnh">Đông lạnh</option>
      <option value="Rau tươi / đồ chế biến">Rau tươi / đồ chế biến</option>
      <option value="Gia vị">Gia vị</option>
      <option value="Mì / bún / phở khô">Mì / bún / phở khô</option>
      <option value="Đồ uống">Đồ uống</option>
      <option value="Khác">Khác</option>
    </select>
  </div>

  <div class="field">
    <label>Số lượng:</label>
    <input id="qtyInput" type="number" value="1" min="0" />
  </div>

  <div class="field">
    <label>Vị trí / Kệ:</label>
    <input id="locationInput" />
  </div>

  <div class="field">
    <label>Ghi chú:</label>
    <input id="noteInput" />
  </div>

  <div class="field">
    <div>
      <button id="saveBtn">Lưu / Thêm mới</button>
      <button id="resetBtn">Xóa form</button>
    </div>
  </div>

  <div class="field">
    <label>Import CSV hiện có:</label>
    <input id="csvFileInput" type="file" accept=".csv" />
    <div class="small">
      CSV nên có header: <b>barcode,name,category,qty,location,note,updated_at</b>.  
      Nếu chưa có <b>category</b> cũng import được, app sẽ để trống.
    </div>
  </div>

  <div class="field">
    <button id="exportBtn">Export CSV kiểm kho</button>
    <div class="small">
      Dữ liệu cũng được lưu tạm trong trình duyệt (localStorage).
    </div>
  </div>

  <!-- Bảng dữ liệu -->
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Mã vạch</th>
        <th>Tên sản phẩm</th>
        <th>Danh mục</th>
        <th>Số lượng</th>
        <th>Vị trí</th>
        <th>Ghi chú</th>
        <th>Cập nhật lúc</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <script>
    const barcodeInput = document.getElementById('barcodeInput');
    const nameInput = document.getElementById('nameInput');
    const categoryInput = document.getElementById('categoryInput');
    const qtyInput = document.getElementById('qtyInput');
    const locationInput = document.getElementById('locationInput');
    const noteInput = document.getElementById('noteInput');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const csvFileInput = document.getElementById('csvFileInput');
    const exportBtn = document.getElementById('exportBtn');
    const itemsBody = document.getElementById('itemsBody');

    // items: { barcode, name, category, qty, location, note, updated_at }
    let items = [];

    function loadFromLocalStorage() {
      const raw = localStorage.getItem('inventoryItems_v2');
      if (!raw) return;
      try {
        items = JSON.parse(raw);
        renderTable();
      } catch (e) {
        console.error('LS parse error', e);
      }
    }

    function saveToLocalStorage() {
      localStorage.setItem('inventoryItems_v2', JSON.stringify(items));
    }

    function nowString() {
      const d = new Date();
      const pad = (n) => (n < 10 ? '0' + n : n);
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} `
           + `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function renderTable(highlightBarcode = null) {
      itemsBody.innerHTML = '';
      items.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.barcode = item.barcode || '';

        if (highlightBarcode && item.barcode === highlightBarcode) {
          tr.classList.add('highlight');
        }

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${item.barcode || ''}</td>
          <td>${item.name || ''}</td>
          <td>${item.category || ''}</td>
          <td>${item.qty ?? ''}</td>
          <td>${item.location || ''}</td>
          <td>${item.note || ''}</td>
          <td>${item.updated_at || ''}</td>
        `;

        tr.addEventListener('click', () => {
          loadItemToForm(item);
          barcodeInput.focus();
          barcodeInput.select();
        });

        itemsBody.appendChild(tr);
      });

      // Scroll vào dòng được highlight nếu có
      if (highlightBarcode) {
        const row = itemsBody.querySelector(`tr[data-barcode="${highlightBarcode}"]`);
        if (row) {
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    function loadItemToForm(item) {
      barcodeInput.value = item.barcode || '';
      nameInput.value = item.name || '';
      categoryInput.value = item.category || '';
      qtyInput.value = item.qty ?? 0;
      locationInput.value = item.location || '';
      noteInput.value = item.note || '';
    }

    function resetForm() {
      barcodeInput.value = '';
      nameInput.value = '';
      categoryInput.value = '';
      qtyInput.value = '1';
      locationInput.value = '';
      noteInput.value = '';
      barcodeInput.focus();
    }

    function upsertItemFromForm() {
      const barcode = (barcodeInput.value || '').trim();
      if (!barcode) {
        alert('Chưa có mã vạch');
        barcodeInput.focus();
        return;
      }

      const name = (nameInput.value || '').trim();
      const category = (categoryInput.value || '').trim();
      let qty = parseInt(qtyInput.value, 10);
      if (isNaN(qty)) qty = 0;
      const location = (locationInput.value || '').trim();
      const note = (noteInput.value || '').trim();

      let existing = items.find((i) => i.barcode === barcode);

      if (existing) {
        // Cập nhật
        existing.name = name;
        existing.category = category;
        existing.qty = qty;
        existing.location = location;
        existing.note = note;
        existing.updated_at = nowString();
      } else {
        // Thêm mới
        existing = {
          barcode,
          name,
          category,
          qty,
          location,
          note,
          updated_at: nowString(),
        };
        items.push(existing);
      }

      saveToLocalStorage();
      renderTable(barcode);
    }

    // Khi quét mã vạch xong (Enter trong ô barcode)
    function handleBarcodeEnter() {
      const barcode = (barcodeInput.value || '').trim();
      if (!barcode) return;

      const existing = items.find((i) => i.barcode === barcode);

      if (existing) {
        // Mã đã tồn tại → load lên form + highlight dòng
        loadItemToForm(existing);
        renderTable(barcode);
      } else {
        // Mã chưa tồn tại → giữ nguyên mã vạch, các ô khác reset nhẹ
        nameInput.value = '';
        categoryInput.value = '';
        qtyInput.value = '1';
        locationInput.value = '';
        noteInput.value = '';
      }
    }

    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter((l) => l.trim() !== '');
      if (lines.length === 0) return;
      const header = lines[0].split(',');

      const getIdx = (name) => header.indexOf(name);

      const idxBarcode = getIdx('barcode');
      const idxName = getIdx('name');
      const idxCategory = getIdx('category'); // có thể -1 nếu file cũ chưa có
      const idxQty = getIdx('qty');
      const idxLocation = getIdx('location');
      const idxNote = getIdx('note');
      const idxUpdated = getIdx('updated_at');

      items = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        if (!cols.length) continue;
        const barcode = cols[idxBarcode] || '';
        if (!barcode) continue;

        items.push({
          barcode: barcode,
          name: idxName >= 0 ? (cols[idxName] || '') : '',
          category: idxCategory >= 0 ? (cols[idxCategory] || '') : '',
          qty: idxQty >= 0 && cols[idxQty] ? (parseInt(cols[idxQty], 10) || 0) : 0,
          location: idxLocation >= 0 ? (cols[idxLocation] || '') : '',
          note: idxNote >= 0 ? (cols[idxNote] || '') : '',
          updated_at: idxUpdated >= 0 ? (cols[idxUpdated] || '') : '',
        });
      }

      saveToLocalStorage();
      renderTable();
      alert('Import CSV xong: ' + items.length + ' sản phẩm');
    }

    function exportCsv() {
      if (!items.length) {
        alert('Chưa có dữ liệu để export');
        return;
      }
      const header = 'barcode,name,category,qty,location,note,updated_at';
      const lines = [header];

      items.forEach((item) => {
        const row = [
          item.barcode || '',
          (item.name || '').replace(/,/g, ' '),
          (item.category || '').replace(/,/g, ' '),
          item.qty ?? 0,
          (item.location || '').replace(/,/g, ' '),
          (item.note || '').replace(/,/g, ' '),
          item.updated_at || '',
        ];
        lines.push(row.join(','));
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hang-kiem-kho.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Events
    saveBtn.addEventListener('click', upsertItemFromForm);
    resetBtn.addEventListener('click', resetForm);

    barcodeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        // Khi scanner gửi Enter → chỉ kiểm tra/nhảy dòng, chưa lưu
        e.preventDefault();
        handleBarcodeEnter();
      }
    });

    csvFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        parseCsv(event.target.result);
      };
      reader.readAsText(file, 'utf-8');
    });

    exportBtn.addEventListener('click', exportCsv);

    loadFromLocalStorage();
    barcodeInput.focus();
  </script>
</body>
</html>
