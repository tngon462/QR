<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Ki·ªÉm kho T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
    }
    h1 {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }
    .field {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }
    .inline {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    label {
      font-size: 13px;
      margin-bottom: 2px;
    }
    input, select, button {
      padding: 8px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .barcode-input {
      font-size: 16px;
      font-weight: bold;
      flex: 1;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .highlight {
      background: #fff3cd !important;
    }
    .camera-preview {
      display: none;
      width: 100%;
      max-height: 300px;
      border: 1px solid #ccc;
      margin-top: 6px;
      border-radius: 4px;
    }
    #stopCameraBtn {
      display: none;
    }
  </style>
</head>
<body>
  <h1>App ki·ªÉm kho (beta)</h1>

  <!-- Form nh·∫≠p -->
  <div class="field">
    <label>M√£ v·∫°ch (qu√©t ho·∫∑c g√µ):</label>
    <div class="inline">
      <input id="barcodeInput" class="barcode-input" autofocus />
      <button id="cameraBtn" type="button">üì∑ Qu√©t</button>
    </div>
    <div class="small">
      ƒê·∫ßu ƒë·ªçc: qu√©t xong th∆∞·ªùng s·∫Ω t·ª± Enter.<br>
      N·∫øu m√£ ƒë√£ c√≥ ‚Üí t·ª± nh·∫£y ƒë·∫øn d√≤ng ƒë√≥. N·∫øu ch∆∞a c√≥ ‚Üí gi·ªØ nguy√™n ƒë·ªÉ nh·∫≠p ti·∫øp.
    </div>
    <video id="cameraPreview" class="camera-preview" autoplay playsinline></video>
    <button id="stopCameraBtn" type="button">T·∫Øt camera</button>
  </div>

  <div class="field">
    <label>T√™n s·∫£n ph·∫©m:</label>
    <input id="nameInput" />
  </div>

  <div class="field">
    <label>·∫¢nh (URL / t√™n file):</label>
    <input id="imageInput" placeholder="V√≠ d·ª•: https://...jpg ho·∫∑c 4900001.jpg" />
    <div class="small">
      Sau n√†y d√πng l√†m c·ªôt ·∫£nh ƒë·ªÉ ƒë·∫©y l√™n Shopify (link ho·∫∑c t√™n file ·∫£nh).
    </div>
  </div>

  <div class="field">
    <label>Danh m·ª•c:</label>
    <!-- input + datalist: v·ª´a g√µ tay ƒë∆∞·ª£c, v·ª´a ch·ªçn t·ª´ list g·ª£i √Ω -->
    <input id="categoryInput" list="categoryList" placeholder="Ch·ªçn ho·∫∑c g√µ danh m·ª•c..." />
    <datalist id="categoryList">
      <!-- S·∫Ω ƒë∆∞·ª£c fill t·ª± ƒë·ªông t·ª´ CSV -->
    </datalist>
    <div class="small">Danh m·ª•c s·∫Ω g·ª£i √Ω t·ª´ file CSV import. N·∫øu kh√¥ng c√≥ th√¨ g√µ tay.</div>
  </div>

  <div class="field">
    <label>S·ªë l∆∞·ª£ng (ƒë·∫øm khi ki·ªÉm):</label>
    <input id="qtyInput" type="number" value="1" min="0" />
  </div>

  <div class="field">
    <label>T·ªìn kho (theo h·ªá th·ªëng / c≈©):</label>
    <input id="stockInput" type="number" value="" min="0" />
  </div>

  <div class="field">
    <label>Ghi ch√∫:</label>
    <input id="noteInput" />
  </div>

  <div class="field">
    <div>
      <button id="saveBtn">L∆∞u / Th√™m m·ªõi</button>
      <button id="resetBtn">X√≥a form</button>
    </div>
  </div>

  <div class="field">
    <label>Import CSV hi·ªán c√≥:</label>
    <input id="csvFileInput" type="file" accept=".csv" />
    <div class="small">
      CSV chu·∫©n n√™n c√≥ header:<br>
      <b>barcode,name,image,category,qty,stock,note,updated_at</b><br>
      Thi·∫øu c·ªôt n√†o c≈©ng import ƒë∆∞·ª£c, app s·∫Ω ƒë·ªÉ tr·ªëng ph·∫ßn ƒë√≥.
    </div>
  </div>

  <div class="field">
    <button id="exportBtn">Export CSV ki·ªÉm kho</button>
    <div class="small">
      D·ªØ li·ªáu c≈©ng ƒë∆∞·ª£c l∆∞u t·∫°m trong tr√¨nh duy·ªát (localStorage).
    </div>
  </div>

  <!-- B·∫£ng d·ªØ li·ªáu -->
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>M√£ v·∫°ch</th>
        <th>T√™n s·∫£n ph·∫©m</th>
        <th>·∫¢nh</th>
        <th>Danh m·ª•c</th>
        <th>S·ªë l∆∞·ª£ng</th>
        <th>T·ªìn kho</th>
        <th>Ghi ch√∫</th>
        <th>C·∫≠p nh·∫≠t l√∫c</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <script>
    const barcodeInput   = document.getElementById('barcodeInput');
    const nameInput      = document.getElementById('nameInput');
    const imageInput     = document.getElementById('imageInput');
    const categoryInput  = document.getElementById('categoryInput');
    const qtyInput       = document.getElementById('qtyInput');
    const stockInput     = document.getElementById('stockInput');
    const noteInput      = document.getElementById('noteInput');
    const saveBtn        = document.getElementById('saveBtn');
    const resetBtn       = document.getElementById('resetBtn');
    const csvFileInput   = document.getElementById('csvFileInput');
    const exportBtn      = document.getElementById('exportBtn');
    const itemsBody      = document.getElementById('itemsBody');
    const categoryListEl = document.getElementById('categoryList');

    const cameraBtn      = document.getElementById('cameraBtn');
    const cameraPreview  = document.getElementById('cameraPreview');
    const stopCameraBtn  = document.getElementById('stopCameraBtn');

    // items: { barcode, name, image, category, qty, stock, note, updated_at }
    let items = [];

    // Camera / BarcodeDetector
    let cameraStream = null;
    let scanning = false;
    let barcodeDetector = null;
    if ('BarcodeDetector' in window) {
      try {
        barcodeDetector = new BarcodeDetector({
          formats: ['ean_13', 'ean_8', 'code_128', 'code_39', 'upc_a', 'upc_e', 'qr_code']
        });
      } catch (e) {
        console.warn('BarcodeDetector init error', e);
        barcodeDetector = null;
      }
    }

    function loadFromLocalStorage() {
      const raw = localStorage.getItem('inventoryItems_v4');
      if (!raw) return;
      try {
        items = JSON.parse(raw);
        renderTable();
        rebuildCategoryList();
      } catch (e) {
        console.error('LS parse error', e);
      }
    }

    function saveToLocalStorage() {
      localStorage.setItem('inventoryItems_v4', JSON.stringify(items));
    }

    function nowString() {
      const d = new Date();
      const pad = (n) => (n < 10 ? '0' + n : n);
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} `
           + `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function renderTable(highlightBarcode = null) {
      itemsBody.innerHTML = '';
      items.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.barcode = item.barcode || '';

        if (highlightBarcode && item.barcode === highlightBarcode) {
          tr.classList.add('highlight');
        }

        // N·∫øu image l√† URL, hi·ªÉn th·ªã d·∫°ng link ng·∫Øn, n·∫øu kh√¥ng th√¨ text
        const imgText = item.image || '';
        const imgCell = imgText
          ? (imgText.startsWith('http')
              ? `<a href="${imgText}" target="_blank">Xem</a>`
              : imgText)
          : '';

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${item.barcode || ''}</td>
          <td>${item.name || ''}</td>
          <td>${imgCell}</td>
          <td>${item.category || ''}</td>
          <td>${item.qty ?? ''}</td>
          <td>${item.stock ?? ''}</td>
          <td>${item.note || ''}</td>
          <td>${item.updated_at || ''}</td>
        `;

        tr.addEventListener('click', () => {
          loadItemToForm(item);
          barcodeInput.focus();
          barcodeInput.select();
        });

        itemsBody.appendChild(tr);
      });

      if (highlightBarcode) {
        const row = itemsBody.querySelector(`tr[data-barcode="${highlightBarcode}"]`);
        if (row) {
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    function loadItemToForm(item) {
      barcodeInput.value  = item.barcode || '';
      nameInput.value     = item.name || '';
      imageInput.value    = item.image || '';
      categoryInput.value = item.category || '';
      qtyInput.value      = item.qty ?? 0;
      stockInput.value    = item.stock ?? '';
      noteInput.value     = item.note || '';
    }

    function resetForm() {
      barcodeInput.value  = '';
      nameInput.value     = '';
      imageInput.value    = '';
      categoryInput.value = '';
      qtyInput.value      = '1';
      stockInput.value    = '';
      noteInput.value     = '';
      barcodeInput.focus();
    }

    function upsertItemFromForm() {
      const barcode  = (barcodeInput.value || '').trim();
      if (!barcode) {
        alert('Ch∆∞a c√≥ m√£ v·∫°ch');
        barcodeInput.focus();
        return;
      }

      const name     = (nameInput.value || '').trim();
      const image    = (imageInput.value || '').trim();
      const category = (categoryInput.value || '').trim();
      let qty        = parseInt(qtyInput.value, 10);
      if (isNaN(qty)) qty = 0;
      let stock      = parseInt(stockInput.value, 10);
      if (isNaN(stock)) stock = '';

      const note     = (noteInput.value || '').trim();

      let existing = items.find((i) => i.barcode === barcode);

      if (existing) {
        existing.name       = name;
        existing.image      = image;
        existing.category   = category;
        existing.qty        = qty;
        existing.stock      = stock;
        existing.note       = note;
        existing.updated_at = nowString();
      } else {
        existing = {
          barcode,
          name,
          image,
          category,
          qty,
          stock,
          note,
          updated_at: nowString(),
        };
        items.push(existing);
      }

      saveToLocalStorage();
      rebuildCategoryList();
      renderTable(barcode);
    }

    // Khi qu√©t m√£ v·∫°ch xong (Enter trong √¥ barcode)
    function handleBarcodeEnter() {
      const barcode = (barcodeInput.value || '').trim();
      if (!barcode) return;

      const existing = items.find((i) => i.barcode === barcode);

      if (existing) {
        // M√£ ƒë√£ t·ªìn t·∫°i ‚Üí load l√™n form + highlight d√≤ng
        loadItemToForm(existing);
        renderTable(barcode);
      } else {
        // M√£ ch∆∞a t·ªìn t·∫°i ‚Üí gi·ªØ nguy√™n m√£ v·∫°ch, c√°c √¥ kh√°c reset nh·∫π
        nameInput.value     = '';
        imageInput.value    = '';
        categoryInput.value = '';
        qtyInput.value      = '1';
        stockInput.value    = '';
        noteInput.value     = '';
      }
    }

    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter((l) => l.trim() !== '');
      if (lines.length === 0) return;

      const header = lines[0].split(',');
      const getIdx = (name) => header.indexOf(name);

      const idxBarcode  = getIdx('barcode');
      const idxName     = getIdx('name');
      const idxImage    = getIdx('image');    // m·ªõi th√™m
      const idxCategory = getIdx('category');
      const idxQty      = getIdx('qty');
      const idxStock    = getIdx('stock');
      const idxNote     = getIdx('note');
      const idxUpdated  = getIdx('updated_at');

      items = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        if (!cols.length) continue;
        const barcode = cols[idxBarcode] || '';
        if (!barcode) continue;

        items.push({
          barcode: barcode,
          name: idxName >= 0 ? (cols[idxName] || '') : '',
          image: idxImage >= 0 ? (cols[idxImage] || '') : '',
          category: idxCategory >= 0 ? (cols[idxCategory] || '') : '',
          qty: idxQty >= 0 && cols[idxQty] ? (parseInt(cols[idxQty], 10) || 0) : 0,
          stock: idxStock >= 0 && cols[idxStock] ? (parseInt(cols[idxStock], 10) || 0) : '',
          note: idxNote >= 0 ? (cols[idxNote] || '') : '',
          updated_at: idxUpdated >= 0 ? (cols[idxUpdated] || '') : '',
        });
      }

      saveToLocalStorage();
      rebuildCategoryList();
      renderTable();
      alert('Import CSV xong: ' + items.length + ' s·∫£n ph·∫©m');
    }

    function exportCsv() {
      if (!items.length) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ export');
        return;
      }
      const header = 'barcode,name,image,category,qty,stock,note,updated_at';
      const lines = [header];

      items.forEach((item) => {
        const row = [
          item.barcode || '',
          (item.name || '').replace(/,/g, ' '),
          (item.image || '').replace(/,/g, ' '),
          (item.category || '').replace(/,/g, ' '),
          item.qty ?? 0,
          (item.stock !== '' && item.stock != null ? item.stock : ''),
          (item.note || '').replace(/,/g, ' '),
          item.updated_at || '',
        ];
        lines.push(row.join(','));
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hang-kiem-kho.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function rebuildCategoryList() {
      const set = new Set();
      items.forEach((item) => {
        if (item.category && item.category.trim()) {
          set.add(item.category.trim());
        }
      });

      categoryListEl.innerHTML = '';
      Array.from(set).sort().forEach((cat) => {
        const opt = document.createElement('option');
        opt.value = cat;
        categoryListEl.appendChild(opt);
      });
    }

    // ==== Camera scan ====
    async function startCameraScan() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Tr√¨nh duy·ªát kh√¥ng cho d√πng camera. D√πng ƒë·∫ßu ƒë·ªçc ho·∫∑c nh·∫≠p tay gi√∫p em.');
        return;
      }
      if (!barcodeDetector) {
        alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ BarcodeDetector.\nTh·ª≠ Chrome b·∫£n m·ªõi tr√™n Android/iOS gi√∫p em.');
        return;
      }

      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        cameraPreview.srcObject = cameraStream;
        cameraPreview.style.display = 'block';
        stopCameraBtn.style.display = 'inline-block';
        scanning = true;
        scanLoop();
      } catch (e) {
        console.error('getUserMedia error', e);
        alert('Kh√¥ng m·ªü ƒë∆∞·ª£c camera. Ki·ªÉm tra quy·ªÅn truy c·∫≠p camera gi√∫p em.');
      }
    }

    function stopCameraScan() {
      scanning = false;
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
      }
      cameraPreview.srcObject = null;
      cameraPreview.style.display = 'none';
      stopCameraBtn.style.display = 'none';
    }

    async function scanLoop() {
      if (!scanning || !barcodeDetector) return;
      try {
        const barcodes = await barcodeDetector.detect(cameraPreview);
        if (barcodes.length > 0) {
          const code = barcodes[0].rawValue;
          if (code) {
            barcodeInput.value = code;
            if (navigator.vibrate) navigator.vibrate(80);
            stopCameraScan();
            handleBarcodeEnter();
            return;
          }
        }
      } catch (e) {
        console.error('detect error', e);
      }
      requestAnimationFrame(scanLoop);
    }

    // Events
    saveBtn.addEventListener('click', upsertItemFromForm);
    resetBtn.addEventListener('click', resetForm);

    barcodeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleBarcodeEnter();
      }
    });

    csvFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        parseCsv(event.target.result);
      };
      reader.readAsText(file, 'utf-8');
    });

    exportBtn.addEventListener('click', exportCsv);

    cameraBtn.addEventListener('click', () => {
      if (scanning) {
        stopCameraScan();
      } else {
        startCameraScan();
      }
    });

    stopCameraBtn.addEventListener('click', stopCameraScan);

    loadFromLocalStorage();
    barcodeInput.focus();
  </script>
</body>
</html>
