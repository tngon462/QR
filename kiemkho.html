<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Ki·ªÉm kho T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 10px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 8px;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }
    .toolbar label {
      font-size: 13px;
      white-space: nowrap;
    }
    .toolbar input[type="file"] {
      font-size: 13px;
    }
    .section-card {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title small {
      font-weight: 400;
      font-size: 0.8rem;
      color: #666;
    }
    .field {
      display: flex;
      flex-direction: column;
      margin-bottom: 6px;
    }
    .field label {
      font-size: 13px;
      margin-bottom: 2px;
    }
    .inline {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    input[type="text"],
    input[type="number"],
    input[type="search"],
    textarea {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
      width: 100%;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      background: #1976d2;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    button.secondary {
      background: #666;
    }
    button.outline {
      background: #fff;
      color: #1976d2;
      border: 1px solid #1976d2;
    }
    button.danger {
      background: #d32f2f;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .two-cols {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 10px;
    }
    @media (max-width: 900px) {
      .two-cols {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .img-thumb {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fafafa;
    }
    .img-thumb.empty {
      object-fit: contain;
      opacity: 0.4;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #0d47a1;
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 3px;
    }
    .badge .x {
      margin-left: 4px;
      cursor: pointer;
      font-weight: 600;
    }

    .tags-wrapper {
      position: relative;
    }
    .tags-display {
      min-height: 32px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 6px;
      background: #fff;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      cursor: pointer;
    }
    .tags-display.placeholder {
      color: #999;
      font-size: 12px;
      align-items: center;
    }
    .tags-dropdown {
      position: absolute;
      z-index: 20;
      background: #fff;
      border-radius: 4px;
      border: 1px solid #ccc;
      padding: 6px;
      margin-top: 2px;
      max-height: 220px;
      overflow: auto;
      width: 100%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .tags-dropdown.hidden {
      display: none;
    }
    .tags-dropdown label {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 0;
      font-size: 12px;
      cursor: pointer;
    }
    .tags-dropdown button {
      width: 100%;
      margin-top: 4px;
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .table-wrapper {
      max-height: 400px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      position: sticky;
      top: 0;
      background: #fafafa;
      z-index: 1;
      font-weight: 600;
    }
    tr:hover {
      background: #f1f8ff;
      cursor: pointer;
    }
    tr.selected {
      background: #e3f2fd;
    }
    .text-right {
      text-align: right;
    }
    .text-center {
      text-align: center;
    }
    .pill {
      padding: 2px 6px;
      border-radius: 999px;
      background: #eee;
      font-size: 11px;
    }
    .small {
      font-size: 11px;
      color: #666;
    }
    .search-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }
    .search-row input {
      flex: 1;
    }
  </style>
</head>
<body>
  <h1>App ki·ªÉm kho T-NGON</h1>

  <!-- Khu v·ª±c n·∫°p file & export -->
  <div class="section-card">
    <div class="section-title">
      <span>1. File d·ªØ li·ªáu kho</span>
      <small>CSV c·ªôt: M√£ v·∫°ch, T√™n s·∫£n ph·∫©m, ·∫¢nh, Danh m·ª•c, Gi√° b√°n, S·ªë l∆∞·ª£ng, T·ªìn kho, Ghi ch√∫, C·∫≠p nh·∫≠t l√∫c (+ Tags)</small>
    </div>
    <div class="toolbar">
      <label>
        Ch·ªçn file CSV:
        <input type="file" id="csvFileInput" accept=".csv" />
      </label>
      <button id="downloadCsvBtn" type="button" disabled>T·∫£i CSV (kho hi·ªán t·∫°i)</button>
      <button id="exportShopifyBtn" type="button" disabled>T·∫£i file cho Shopify</button>
      <button id="exportKiotVietBtn" type="button" disabled>T·∫£i file cho KiotViet</button>
      <span class="small" id="summaryText"></span>
    </div>
  </div>

  <div class="two-cols">
    <!-- C·ªôt tr√°i: form chi ti·∫øt -->
    <div class="section-card">
      <div class="section-title">
        <span>2. Th√¥ng tin s·∫£n ph·∫©m</span>
        <small id="currentStatus">Ch∆∞a ch·ªçn s·∫£n ph·∫©m</small>
      </div>

      <div class="field">
        <label>M√£ v·∫°ch / M√£ h√†ng:</label>
        <div class="inline">
          <input id="barcodeInput" type="text" autocomplete="off" />
          <button id="clearFormBtn" type="button" class="secondary">L√†m m·ªõi form</button>
        </div>
        <div class="small">
          ‚ûú Qu√©t ƒë·∫ßu ƒë·ªçc m√£ v·∫°ch r·ªìi ·∫•n <b>Enter</b> (ho·∫∑c ƒë·∫ßu ƒë·ªçc t·ª± g·ª≠i Enter). N·∫øu c√≥ s·∫µn s·∫Ω load l√™n, kh√¥ng c√≥ s·∫Ω t·∫°o m·ªõi.
        </div>
      </div>

      <div class="field">
        <label>T√™n s·∫£n ph·∫©m:</label>
        <input id="nameInput" type="text" />
      </div>

      <div class="field">
        <label>·∫¢nh (URL):</label>
        <div class="inline">
          <input id="imageInput" type="text" placeholder="D√°n link ·∫£nh (GitHub / CDN / ...)" />
          <button id="openImageBtn" type="button" class="outline">M·ªü ·∫£nh</button>
        </div>
        <div style="margin-top:6px; display:flex; gap:10px; align-items:center;">
          <img id="imageThumb" class="img-thumb empty" src="" alt="·∫¢nh" />
          <span class="small">N·∫øu tr·ªëng th√¨ s·∫£n ph·∫©m ch∆∞a c√≥ ·∫£nh. Khi export Shopify / KiotViet, c·ªôt ·∫£nh s·∫Ω tr·ªëng.</span>
        </div>
      </div>

      <div class="field">
        <label>Danh m·ª•c (3 c·∫•p, v√≠ d·ª•: ƒê·ªì kh√¥&gt;&gt;Gia v·ªã&gt;&gt;M·∫Øm):</label>
        <input id="categoryInput" list="categoryList" type="text" placeholder="G√µ ho·∫∑c ch·ªçn t·ª´ danh s√°ch..." autocomplete="off" />
        <datalist id="categoryList"></datalist>
      </div>

      <div class="field">
        <label>Tags:</label>
        <div class="tags-wrapper">
          <div id="tagsDisplay" class="tags-display placeholder">
            + Ch·ªçn / th√™m tag (nhi·ªÅu tag / 1 s·∫£n ph·∫©m)
          </div>
          <div id="tagsDropdown" class="tags-dropdown hidden"></div>
        </div>
        <input id="tagsInput" type="hidden" />
      </div>

      <div class="field">
        <label>Gi√° b√°n (JPY):</label>
        <input id="priceInput" type="number" min="0" step="1" />
      </div>

      <div class="field">
        <label>S·ªë l∆∞·ª£ng ki·ªÉm (d√πng ƒë·ªÉ c·∫≠p nh·∫≠t t·ªìn kho):</label>
        <input id="quantityInput" type="number" step="1" />
      </div>

      <div class="field">
        <label>T·ªìn kho (theo h·ªá th·ªëng hi·ªán t·∫°i ‚Äì n·∫øu c√≥):</label>
        <input id="stockInput" type="number" step="1" />
      </div>

      <div class="field">
        <label>Ghi ch√∫:</label>
        <textarea id="noteInput"></textarea>
      </div>

      <div class="actions-row">
        <button id="saveItemBtn" type="button">üíæ L∆∞u / C·∫≠p nh·∫≠t s·∫£n ph·∫©m</button>
        <button id="deleteItemBtn" type="button" class="danger">üóë Xo√° s·∫£n ph·∫©m</button>
      </div>
    </div>

    <!-- C·ªôt ph·∫£i: danh s√°ch h√†ng -->
    <div class="section-card">
      <div class="section-title">
        <span>3. Danh s√°ch h√†ng h√≥a</span>
      </div>

      <div class="search-row">
        <input id="searchInput" type="search" placeholder="T√¨m theo m√£ v·∫°ch / t√™n / danh m·ª•c / tag..." />
        <button id="clearSearchBtn" type="button" class="secondary">Xo√° t√¨m</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>M√£ v·∫°ch</th>
              <th>T√™n</th>
              <th>Danh m·ª•c</th>
              <th>Tags</th>
              <th class="text-right">Gi√°</th>
              <th class="text-right">SL</th>
              <th>·∫¢nh</th>
            </tr>
          </thead>
          <tbody id="itemsTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ======================
    // Bi·∫øn global
    // ======================
    let items = [];          // danh s√°ch s·∫£n ph·∫©m
    let currentIndex = -1;   // index trong items ƒëang ch·ªçn
    let allCategories = new Set();
    let allTags = new Set();
    let tagsDropdownOpen = false;

    // ======================
    // Ti·ªán √≠ch CSV
    // ======================

    function parseCSV(text) {
      const rows = [];
      let field = '';
      let row = [];
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (i + 1 < text.length && text[i+1] === '"') {
              field += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            field += c;
          }
        } else {
          if (c === '"') {
            inQuotes = true;
          } else if (c === ',') {
            row.push(field);
            field = '';
          } else if (c === '\n' || c === '\r') {
            if (field.length > 0 || row.length > 0) {
              row.push(field);
              rows.push(row);
              row = [];
              field = '';
            }
            if (c === '\r' && i+1 < text.length && text[i+1] === '\n') {
              i++;
            }
          } else {
            field += c;
          }
        }
      }
      if (field.length > 0 || row.length > 0) {
        row.push(field);
        rows.push(row);
      }
      return rows;
    }

    function csvEscape(value) {
      if (value == null) return '';
      const s = String(value);
      if (/[",\n\r]/.test(s)) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }

    function buildCSV(headers, rows) {
      const headerLine = headers.map(csvEscape).join(',');
      const lines = [headerLine];
      for (const row of rows) {
        const line = headers.map(h => csvEscape(row[h] ?? '')).join(',');
        lines.push(line);
      }
      return lines.join('\r\n');
    }

    function downloadFile(filename, text) {
      const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ======================
    // ƒê·ªçc file CSV kho
    // ======================

    const csvFileInput = document.getElementById('csvFileInput');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const exportShopifyBtn = document.getElementById('exportShopifyBtn');
    const exportKiotVietBtn = document.getElementById('exportKiotVietBtn');
    const summaryText = document.getElementById('summaryText');

    csvFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const text = evt.target.result;
          const rows = parseCSV(text);
          if (!rows.length) {
            alert('File CSV r·ªóng.');
            return;
          }
          const header = rows[0];
          const dataRows = rows.slice(1);
          const colIndex = (name) => header.indexOf(name);

          const idxBarcode = colIndex('M√£ v·∫°ch');
          const idxName = colIndex('T√™n s·∫£n ph·∫©m');
          const idxImg = colIndex('·∫¢nh');
          const idxCat = colIndex('Danh m·ª•c');
          const idxPrice = colIndex('Gi√° b√°n');
          const idxQty = colIndex('S·ªë l∆∞·ª£ng');
          const idxStock = colIndex('T·ªìn kho');
          const idxNote = colIndex('Ghi ch√∫');
          const idxUpdated = colIndex('C·∫≠p nh·∫≠t l√∫c');
          const idxTags = colIndex('Tags'); // c√≥ th·ªÉ -1 n·∫øu file c≈©

          if (idxBarcode === -1 || idxName === -1 || idxCat === -1) {
            alert('CSV thi·∫øu c·ªôt b·∫Øt bu·ªôc (M√£ v·∫°ch / T√™n s·∫£n ph·∫©m / Danh m·ª•c).');
            return;
          }

          items = [];
          allCategories = new Set();
          allTags = new Set();

          for (const row of dataRows) {
            if (row.length === 0 || (row[0] === '' && row[1] === '')) continue;
            const obj = {
              barcode: row[idxBarcode] ?? '',
              name: row[idxName] ?? '',
              image: idxImg >= 0 ? (row[idxImg] ?? '') : '',
              category: idxCat >= 0 ? (row[idxCat] ?? '') : '',
              price: idxPrice >= 0 ? Number(row[idxPrice] || 0) : 0,
              quantity: idxQty >= 0 ? Number(row[idxQty] || 0) : 0,
              stock: idxStock >= 0 ? Number(row[idxStock] || 0) : 0,
              note: idxNote >= 0 ? (row[idxNote] ?? '') : '',
              updatedAt: idxUpdated >= 0 ? (row[idxUpdated] ?? '') : '',
              tags: idxTags >= 0 ? (row[idxTags] ?? '') : ''
            };
            items.push(obj);
            if (obj.category) allCategories.add(obj.category);
            if (obj.tags) {
              obj.tags.split(';').map(t => t.trim()).filter(Boolean).forEach(t => allTags.add(t));
            }
          }

          currentIndex = -1;
          updateSummary();
          renderCategoryList();
          rebuildAllTags();
          renderItemsTable();
          enableExportButtons(true);

          alert('ƒê√£ n·∫°p ' + items.length + ' d√≤ng t·ª´ CSV kho.');
        } catch (err) {
          console.error(err);
          alert('L·ªói ƒë·ªçc CSV: ' + err.message);
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    function enableExportButtons(enable) {
      downloadCsvBtn.disabled = !enable;
      exportShopifyBtn.disabled = !enable;
      exportKiotVietBtn.disabled = !enable;
    }

    function updateSummary() {
      summaryText.textContent = items.length
        ? (items.length + ' s·∫£n ph·∫©m | ' + allCategories.size + ' danh m·ª•c | ' + allTags.size + ' tag')
        : '';
    }

    // ======================
    // Render danh m·ª•c & tags
    // ======================

    function renderCategoryList() {
      const datalist = document.getElementById('categoryList');
      datalist.innerHTML = '';
      Array.from(allCategories)
        .sort((a,b) => a.localeCompare(b, 'vi'))
        .forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          datalist.appendChild(opt);
        });
    }

    function rebuildAllTags() {
      allTags = new Set();
      for (const it of items) {
        if (!it.tags) continue;
        it.tags.split(';').map(t => t.trim()).filter(Boolean).forEach(t => allTags.add(t));
      }
      renderTagsDropdown();
      renderTagsDisplay(getCurrentItemTags());
      updateSummary();
    }

    const tagsDisplay = document.getElementById('tagsDisplay');
    const tagsDropdown = document.getElementById('tagsDropdown');
    const tagsInput = document.getElementById('tagsInput');

    function getCurrentItemTags() {
      if (currentIndex < 0 || currentIndex >= items.length) {
        const raw = tagsInput.value || '';
        return raw.split(';').map(t => t.trim()).filter(Boolean);
      }
      const raw = items[currentIndex].tags || '';
      return raw.split(';').map(t => t.trim()).filter(Boolean);
    }

    function renderTagsDisplay(tagArr) {
      tagsDisplay.innerHTML = '';
      const tags = tagArr || [];
      if (!tags.length) {
        tagsDisplay.classList.add('placeholder');
        tagsDisplay.textContent = '+ Ch·ªçn / th√™m tag (nhi·ªÅu tag / 1 s·∫£n ph·∫©m)';
        return;
      }
      tagsDisplay.classList.remove('placeholder');
      tags.forEach(tag => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = tag;
        const x = document.createElement('span');
        x.className = 'x';
        x.textContent = '√ó';
        x.addEventListener('click', (e) => {
          e.stopPropagation();
          const current = new Set(getCurrentItemTags());
          current.delete(tag);
          const newArr = Array.from(current);
          tagsInput.value = newArr.join('; ');
          renderTagsDisplay(newArr);
        });
        span.appendChild(x);
        tagsDisplay.appendChild(span);
      });
    }

    function renderTagsDropdown() {
      tagsDropdown.innerHTML = '';
      if (!allTags.size) {
        const p = document.createElement('div');
        p.className = 'small';
        p.textContent = 'Ch∆∞a c√≥ tag n√†o. B·∫•m "+ Th√™m tag m·ªõi" ƒë·ªÉ t·∫°o.';
        tagsDropdown.appendChild(p);
      } else {
        const currentSet = new Set(getCurrentItemTags());
        Array.from(allTags)
          .sort((a,b) => a.localeCompare(b, 'vi'))
          .forEach(tag => {
            const label = document.createElement('label');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.value = tag;
            if (currentSet.has(tag)) cb.checked = true;
            cb.addEventListener('change', () => {
              const cur = new Set(getCurrentItemTags());
              if (cb.checked) cur.add(tag); else cur.delete(tag);
              const arr = Array.from(cur);
              tagsInput.value = arr.join('; ');
              renderTagsDisplay(arr);
            });
            label.appendChild(cb);
            label.appendChild(document.createTextNode(tag));
            tagsDropdown.appendChild(label);
          });
      }
      const btnAdd = document.createElement('button');
      btnAdd.type = 'button';
      btnAdd.textContent = '+ Th√™m tag m·ªõi';
      btnAdd.addEventListener('click', () => {
        const name = prompt('Nh·∫≠p t√™n tag m·ªõi:').trim();
        if (!name) return;
        allTags.add(name);
        const cur = new Set(getCurrentItemTags());
        cur.add(name);
        const arr = Array.from(cur);
        tagsInput.value = arr.join('; ');
        renderTagsDropdown();
        renderTagsDisplay(arr);
      });
      tagsDropdown.appendChild(btnAdd);
    }

    tagsDisplay.addEventListener('click', () => {
      tagsDropdownOpen = !tagsDropdownOpen;
      tagsDropdown.classList.toggle('hidden', !tagsDropdownOpen);
    });

    document.addEventListener('click', (e) => {
      if (!tagsDropdownOpen) return;
      if (!tagsDisplay.contains(e.target) && !tagsDropdown.contains(e.target)) {
        tagsDropdownOpen = false;
        tagsDropdown.classList.add('hidden');
      }
    });

    // ======================
    // Form chi ti·∫øt
    // ======================

    const barcodeInput = document.getElementById('barcodeInput');
    const nameInput = document.getElementById('nameInput');
    const imageInput = document.getElementById('imageInput');
    const imageThumb = document.getElementById('imageThumb');
    const categoryInput = document.getElementById('categoryInput');
    const priceInput = document.getElementById('priceInput');
    const quantityInput = document.getElementById('quantityInput');
    const stockInput = document.getElementById('stockInput');
    const noteInput = document.getElementById('noteInput');
    const currentStatus = document.getElementById('currentStatus');
    const clearFormBtn = document.getElementById('clearFormBtn');
    const saveItemBtn = document.getElementById('saveItemBtn');
    const deleteItemBtn = document.getElementById('deleteItemBtn');
    const openImageBtn = document.getElementById('openImageBtn');

    function clearForm(resetIndex = true) {
      if (resetIndex) currentIndex = -1;
      barcodeInput.value = '';
      nameInput.value = '';
      imageInput.value = '';
      imageThumb.src = '';
      imageThumb.classList.add('empty');
      categoryInput.value = '';
      priceInput.value = '';
      quantityInput.value = '';
      stockInput.value = '';
      noteInput.value = '';
      tagsInput.value = '';
      renderTagsDisplay([]);
      currentStatus.textContent = 'Ch∆∞a ch·ªçn s·∫£n ph·∫©m';
      highlightSelectedRow();
      barcodeInput.focus();
    }

    clearFormBtn.addEventListener('click', () => clearForm(true));

    imageInput.addEventListener('input', () => {
      const url = imageInput.value.trim();
      if (url) {
        imageThumb.src = url;
        imageThumb.classList.remove('empty');
      } else {
        imageThumb.src = '';
        imageThumb.classList.add('empty');
      }
    });

    openImageBtn.addEventListener('click', () => {
      const url = imageInput.value.trim();
      if (!url) {
        alert('Ch∆∞a c√≥ URL ·∫£nh.');
        return;
      }
      window.open(url, '_blank');
    });

    barcodeInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const code = barcodeInput.value.trim();
        if (!code) return;
        const idx = items.findIndex(it => String(it.barcode).trim() === code);
        if (idx >= 0) {
          selectItem(idx);
        } else {
          clearForm(false);
          barcodeInput.value = code;
          currentStatus.textContent = 'M√£ m·ªõi ‚Äì t·∫°o s·∫£n ph·∫©m m·ªõi';
          barcodeInput.select();
        }
      }
    });

    function fillFormFromItem(item) {
      barcodeInput.value = item.barcode ?? '';
      nameInput.value = item.name ?? '';
      imageInput.value = item.image ?? '';
      if (item.image) {
        imageThumb.src = item.image;
        imageThumb.classList.remove('empty');
      } else {
        imageThumb.src = '';
        imageThumb.classList.add('empty');
      }
      categoryInput.value = item.category ?? '';
      priceInput.value = item.price != null ? item.price : '';
      quantityInput.value = item.quantity != null ? item.quantity : '';
      stockInput.value = item.stock != null ? item.stock : '';
      noteInput.value = item.note ?? '';
      tagsInput.value = item.tags ?? '';
      renderTagsDisplay(getCurrentItemTags());
      currentStatus.textContent = item.updatedAt ? ('C·∫≠p nh·∫≠t l√∫c: ' + item.updatedAt) : 'ƒêang ch·ªânh s·ª≠a';
    }

    function saveCurrentItem() {
      const barcode = barcodeInput.value.trim();
      if (!barcode) {
        alert('M√£ v·∫°ch / M√£ h√†ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
        barcodeInput.focus();
        return;
      }
      const now = new Date();
      const item = {
        barcode,
        name: nameInput.value.trim(),
        image: imageInput.value.trim(),
        category: categoryInput.value.trim(),
        price: priceInput.value ? Number(priceInput.value) : 0,
        quantity: quantityInput.value ? Number(quantityInput.value) : 0,
        stock: stockInput.value ? Number(stockInput.value) : 0,
        note: noteInput.value.trim(),
        updatedAt: now.toISOString().replace('T', ' ').substring(0, 19),
        tags: tagsInput.value || ''
      };

      // c·∫≠p nh·∫≠t sets
      if (item.category) allCategories.add(item.category);
      if (item.tags) {
        item.tags.split(';').map(t => t.trim()).filter(Boolean).forEach(t => allTags.add(t));
      }

      // t√¨m theo barcode
      const existingIndex = items.findIndex(it => String(it.barcode).trim() === barcode);
      if (existingIndex >= 0) {
        items[existingIndex] = item;
        currentIndex = existingIndex;
      } else {
        items.push(item);
        currentIndex = items.length - 1;
      }

      renderCategoryList();
      rebuildAllTags();
      renderItemsTable();
      updateSummary();
      highlightSelectedRow();
      fillFormFromItem(items[currentIndex]);
      alert('ƒê√£ l∆∞u s·∫£n ph·∫©m: ' + (item.name || item.barcode));
    }

    saveItemBtn.addEventListener('click', saveCurrentItem);

    deleteItemBtn.addEventListener('click', () => {
      if (currentIndex < 0 || currentIndex >= items.length) {
        alert('Ch∆∞a ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ xo√°.');
        return;
      }
      const it = items[currentIndex];
      if (!confirm('Xo√° s·∫£n ph·∫©m "' + (it.name || it.barcode) + '"?')) return;
      items.splice(currentIndex, 1);
      currentIndex = -1;
      clearForm(true);
      renderItemsTable();
      rebuildAllTags();
      updateSummary();
    });

    // ======================
    // B·∫£ng danh s√°ch
    // ======================

    const itemsTbody = document.getElementById('itemsTbody');
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    function renderItemsTable() {
      const keyword = searchInput.value.trim().toLowerCase();
      itemsTbody.innerHTML = '';
      items.forEach((it, idx) => {
        if (keyword) {
          const hay = (String(it.barcode) + ' ' + (it.name||'') + ' ' + (it.category||'') + ' ' + (it.tags||'')).toLowerCase();
          if (!hay.includes(keyword)) return;
        }
        const tr = document.createElement('tr');
        if (idx === currentIndex) tr.classList.add('selected');

        const tdBarcode = document.createElement('td');
        tdBarcode.textContent = it.barcode;
        const tdName = document.createElement('td');
        tdName.textContent = it.name;
        const tdCat = document.createElement('td');
        tdCat.textContent = it.category;
        const tdTags = document.createElement('td');
        tdTags.textContent = it.tags || '';
        const tdPrice = document.createElement('td');
        tdPrice.className = 'text-right';
        tdPrice.textContent = it.price ? it.price.toString() : '';
        const tdQty = document.createElement('td');
        tdQty.className = 'text-right';
        tdQty.textContent = it.quantity ? it.quantity.toString() : '';
        const tdImg = document.createElement('td');
        tdImg.className = 'text-center';
        tdImg.innerHTML = it.image ? '<span class="pill">C√≥ ·∫£nh</span>' : '<span class="small">-</span>';

        tr.appendChild(tdBarcode);
        tr.appendChild(tdName);
        tr.appendChild(tdCat);
        tr.appendChild(tdTags);
        tr.appendChild(tdPrice);
        tr.appendChild(tdQty);
        tr.appendChild(tdImg);

        tr.addEventListener('click', () => selectItem(idx));
        itemsTbody.appendChild(tr);
      });
    }

    function highlightSelectedRow() {
      const trs = itemsTbody.querySelectorAll('tr');
      trs.forEach((tr, i) => {
        tr.classList.toggle('selected', i === currentIndex);
      });
    }

    function selectItem(index) {
      if (index < 0 || index >= items.length) return;
      currentIndex = index;
      fillFormFromItem(items[index]);
      highlightSelectedRow();
    }

    searchInput.addEventListener('input', () => {
      renderItemsTable();
    });

    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      renderItemsTable();
    });

    // ======================
    // Export CSV: kho g·ªëc
    // ======================

    downloadCsvBtn.addEventListener('click', () => {
      if (!items.length) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
        return;
      }
      const headers = [
        'M√£ v·∫°ch',
        'T√™n s·∫£n ph·∫©m',
        '·∫¢nh',
        'Danh m·ª•c',
        'Tags',
        'Gi√° b√°n',
        'S·ªë l∆∞·ª£ng',
        'T·ªìn kho',
        'Ghi ch√∫',
        'C·∫≠p nh·∫≠t l√∫c'
      ];
      const rows = items.map(it => ({
        'M√£ v·∫°ch': it.barcode ?? '',
        'T√™n s·∫£n ph·∫©m': it.name ?? '',
        '·∫¢nh': it.image ?? '',
        'Danh m·ª•c': it.category ?? '',
        'Tags': it.tags ?? '',
        'Gi√° b√°n': it.price ?? '',
        'S·ªë l∆∞·ª£ng': it.quantity ?? '',
        'T·ªìn kho': it.stock ?? '',
        'Ghi ch√∫': it.note ?? '',
        'C·∫≠p nh·∫≠t l√∫c': it.updatedAt ?? ''
      }));
      const csv = buildCSV(headers, rows);
      downloadFile('hang-kiem-kho-export.csv', csv);
    });

    // ======================
    // Export CSV: Shopify
    // ======================

    exportShopifyBtn.addEventListener('click', () => {
      if (!items.length) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
        return;
      }

      const headers = [
        'Handle',
        'Title',
        'Body (HTML)',
        'Vendor',
        'Product Category',
        'Type',
        'Tags',
        'Published',
        'Option1 Name',
        'Option1 Value',
        'Option1 Linked To',
        'Option2 Name',
        'Option2 Value',
        'Option2 Linked To',
        'Option3 Name',
        'Option3 Value',
        'Option3 Linked To',
        'Variant SKU',
        'Variant Grams',
        'Variant Inventory Tracker',
        'Variant Inventory Qty',
        'Variant Inventory Policy',
        'Variant Fulfillment Service',
        'Variant Price',
        'Variant Compare At Price',
        'Variant Requires Shipping',
        'Variant Taxable',
        'Unit Price Total Measure',
        'Unit Price Total Measure Unit',
        'Unit Price Base Measure',
        'Unit Price Base Measure Unit',
        'Variant Barcode',
        'Image Src',
        'Image Position',
        'Image Alt Text',
        'Gift Card',
        'SEO Title',
        'SEO Description',
        'Variant Image',
        'Variant Weight Unit',
        'Variant Tax Code',
        'Cost per item',
        'Status'
      ];

      const rows = [];

      for (const it of items) {
        const barcode = (it.barcode ?? '').trim();
        const name = (it.name ?? '').trim();
        if (!barcode && !name) continue;

        const handle = barcode || slugifyHandle(name);
        const type = (it.category || '').split('>>')[0] || '';
        const tagsShopify = (it.tags || '')
          .split(';')
          .map(t => t.trim())
          .filter(Boolean)
          .join(', ');

        const qty = it.quantity != null && !isNaN(it.quantity) ? it.quantity : '';
        const price = it.price != null && !isNaN(it.price) ? it.price : '';
        const img = (it.image || '').trim();

        const row = {};
        row['Handle'] = handle;
        row['Title'] = name || barcode;
        row['Body (HTML)'] = '';
        row['Vendor'] = 'T-NGON';
        row['Product Category'] = '';
        row['Type'] = type;
        row['Tags'] = tagsShopify;
        row['Published'] = 'FALSE'; // an to√†n: l√™n Shopify ·ªü tr·∫°ng th√°i nh√°p
        row['Option1 Name'] = 'Title';
        row['Option1 Value'] = 'Default Title';
        row['Option1 Linked To'] = '';
        row['Option2 Name'] = '';
        row['Option2 Value'] = '';
        row['Option2 Linked To'] = '';
        row['Option3 Name'] = '';
        row['Option3 Value'] = '';
        row['Option3 Linked To'] = '';
        row['Variant SKU'] = barcode;
        row['Variant Grams'] = '';
        row['Variant Inventory Tracker'] = 'shopify';
        row['Variant Inventory Qty'] = qty;
        row['Variant Inventory Policy'] = 'deny';
        row['Variant Fulfillment Service'] = 'manual';
        row['Variant Price'] = price;
        row['Variant Compare At Price'] = '';
        row['Variant Requires Shipping'] = 'TRUE';
        row['Variant Taxable'] = 'TRUE';
        row['Unit Price Total Measure'] = '';
        row['Unit Price Total Measure Unit'] = '';
        row['Unit Price Base Measure'] = '';
        row['Unit Price Base Measure Unit'] = '';
        row['Variant Barcode'] = barcode;
        row['Image Src'] = img;
        row['Image Position'] = img ? '1' : '';
        row['Image Alt Text'] = name || barcode;
        row['Gift Card'] = 'FALSE';
        row['SEO Title'] = '';
        row['SEO Description'] = '';
        row['Variant Image'] = '';
        row['Variant Weight Unit'] = 'g';
        row['Variant Tax Code'] = '';
        row['Cost per item'] = '';
        row['Status'] = 'draft';

        rows.push(row);
      }

      if (!rows.length) {
        alert('Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá ƒë·ªÉ export Shopify.');
        return;
      }

      const csv = buildCSV(headers, rows);
      downloadFile('shopify_import_tngon.csv', csv);
    });

    function slugifyHandle(str) {
      return String(str || '')
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '') || 'sp-' + Date.now();
    }

    // ======================
    // Export CSV: KiotViet
    // ======================

    exportKiotVietBtn.addEventListener('click', () => {
      if (!items.length) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
        return;
      }

      // Map ƒë∆°n gi·∫£n: d√πng M√£ v·∫°ch nh∆∞ M√£ h√†ng, Danh m·ª•c nh∆∞ Nh√≥m h√†ng(3 C·∫•p)
      const headers = [
        'M√£ h√†ng',
        'T√™n h√†ng h√≥a',
        'Nh√≥m h√†ng(3 C·∫•p)',
        'Gi√° b√°n',
        'T·ªìn kho',
        'H√¨nh ·∫£nh (url1,url2...)'
      ];

      const rows = [];

      for (const it of items) {
        const barcode = (it.barcode ?? '').trim();
        const name = (it.name ?? '').trim();
        if (!barcode && !name) continue;

        const tonKho = (it.quantity != null && !isNaN(it.quantity)) 
          ? it.quantity 
          : (it.stock != null && !isNaN(it.stock) ? it.stock : '');

        const row = {};
        row['M√£ h√†ng'] = barcode;
        row['T√™n h√†ng h√≥a'] = name || barcode;
        row['Nh√≥m h√†ng(3 C·∫•p)'] = it.category ?? '';
        row['Gi√° b√°n'] = it.price != null && !isNaN(it.price) ? it.price : '';
        row['T·ªìn kho'] = tonKho;
        row['H√¨nh ·∫£nh (url1,url2...)'] = it.image ?? '';
        rows.push(row);
      }

      if (!rows.length) {
        alert('Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá ƒë·ªÉ export KiotViet.');
        return;
      }

      const csv = buildCSV(headers, rows);
      downloadFile('kiotviet_update_tngon.csv', csv);
    });

    // ======================
    // Kh·ªüi ƒë·ªông
    // ======================

    window.addEventListener('DOMContentLoaded', () => {
      barcodeInput.focus();
      renderTagsDropdown();
      renderTagsDisplay([]);
      enableExportButtons(false);
    });
  </script>
</body>
</html>