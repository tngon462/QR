<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- PWA meta tags for shortcut functionality -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://placehold.co/192x192/da251d/fff?text=TN"/>
  <link rel="apple-touch-icon" href="https://placehold.co/192x192/da251d/fff?text=TN"/>
  <meta name="apple-mobile-web-app-title" content="T-NGON"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="theme-color" content="#da251d">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f3f4f6;
    }
    .main-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      padding: 1rem;
      box-sizing: border-box;
    }
    .screen {
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }
    #table-selection-screen {
        display: flex;
    }
    .button-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      max-width: 600px;
      margin: 2rem auto 0 auto;
    }
    .table-button {
      font-size: 2rem;
      font-weight: bold;
      padding: 2rem 1rem;
      background-color: #007aff;
      color: white;
      border: 2px solid #007aff;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .table-button:hover {
      background-color: #005fbc;
      border-color: #005fbc;
      transform: translateY(-2px);
    }
    .start-button {
      font-size: 2.5rem;
      padding: 1.25rem 2.5rem;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .start-button:hover {
      background-color: #005fbc;
      transform: translateY(-2px);
    }
    .start-button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .iframe-container {
      width: 100%;
      height: 100%;
      border: none;
      overflow: hidden;
    }
    .loading-indicator {
        font-size: 1.5rem;
        color: #6b7280;
        margin-top: 1rem;
    }
    .error-message {
        color: #ef4444;
        font-size: 1.2rem;
        margin-top: 1rem;
    }
    @media (max-width: 640px) {
      .button-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
      .table-button {
        font-size: 1.5rem;
        padding: 1.5rem 0.5rem;
      }
      .start-button {
        font-size: 2rem;
        padding: 1rem 2rem;
      }
    }
    .return-button {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 24px;
      height: 24px;
      padding: 0;
      background-color: transparent;
      border: none;
      cursor: pointer;
      z-index: 100;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="main-container" id="main-container">
    <div class="screen" id="table-selection-screen">
      <h2 class="text-5xl font-bold text-gray-800">T-NGON</h2>
      <p class="text-lg text-gray-600 mt-2">Vui l√≤ng ch·ªçn b√†n c·ªßa b·∫°n</p>
      <div class="button-grid">
        <script>
            for (let i = 1; i <= 15; i++) {
                document.write(`<button class="table-button" onclick="selectTable(${i})">B√†n ${i}</button>`);
            }
        </script>
      </div>
    </div>
    
    <div class="screen" id="start-screen">
      <div class="space-y-4 text-gray-800 text-center">
        <h2 class="text-5xl font-bold">T-NGON</h2>
        <p class="text-lg">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫∑t m√≥n</p>
        <div class="button-container">
          <button class="start-button" onclick="startOrder()">üçΩÔ∏è B·∫ÆT ƒê·∫¶U</button>
        </div>
        <p id="table-info" class="text-sm text-gray-500 mt-4"></p>
      </div>
    </div>

    <div class="screen" id="iframe-screen">
      <button class="return-button" onclick="clearPage()"></button>
    </div>
  </div>

  <script>
    const LINKS_JSON_URL = "https://raw.githubusercontent.com/tngon462/QR/refs/heads/main/links.json";
    let selectedBan = null;
    
    // --- WebSocket Client Logic ---
    const WS_SERVER_URL = "ws://localhost:8765"; // C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ n√†y n·∫øu server Python ch·∫°y tr√™n m√°y kh√°c
    let ws = null;

    function connectWebSocket() {
        // ƒê·∫£m b·∫£o ch·ªâ c√≥ m·ªôt k·∫øt n·ªëi ƒëang m·ªü ho·∫∑c ƒëang c·ªë g·∫Øng k·∫øt n·ªëi
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
            return;
        }

        console.log(`Connecting to WebSocket server at ${WS_SERVER_URL}...`);
        ws = new WebSocket(WS_SERVER_URL);

        ws.onopen = () => {
            console.log("Connected to WebSocket server.");
            // C√≥ th·ªÉ th√™m logic ·ªü ƒë√¢y n·∫øu c·∫ßn, v√≠ d·ª•: g·ª≠i th√¥ng tin b√†n
        };

        ws.onmessage = (event) => {
            console.log("Message from server: ", event.data);
            try {
                const message = JSON.parse(event.data);
                // Ki·ªÉm tra xem tin nh·∫Øn c√≥ ph·∫£i c·ªßa b√†n hi·ªán t·∫°i kh√¥ng
                if (message.ban == selectedBan && message.status === "expired") {
                    console.log(`Table ${selectedBan} has expired. Clearing page.`);
                    // Hi·ªÉn th·ªã th√¥ng b√°o tr∆∞·ªõc khi quay l·∫°i m√†n h√¨nh ch√≠nh
                    showError(`B√†n ${selectedBan} ƒë√£ h·∫øt h·∫°n. ƒêang quay l·∫°i m√†n h√¨nh ch√≠nh...`);
                    // ƒê·ª£i 2 gi√¢y r·ªìi chuy·ªÉn m√†n h√¨nh
                    setTimeout(clearPage, 2000);
                }
            } catch (e) {
                console.error("Failed to parse message:", e);
            }
        };

        ws.onclose = () => {
            // Khi k·∫øt n·ªëi b·ªã ƒë√≥ng, th·ª≠ k·∫øt n·ªëi l·∫°i sau 3 gi√¢y.
            // ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o ·ª©ng d·ª•ng kh√¥ng b√°o l·ªói v√† s·∫Ω t·ª± ƒë·ªông k·∫øt n·ªëi l·∫°i khi server ch·∫°y.
            console.log("Disconnected from WebSocket server. Attempting to reconnect in 3 seconds...");
            setTimeout(connectWebSocket, 3000);
        };

        ws.onerror = (error) => {
            // L·ªói n√†y c≈©ng s·∫Ω k√≠ch ho·∫°t s·ª± ki·ªán onclose, n√™n ch·ªâ c·∫ßn in ra console
            console.error("WebSocket error occurred, attempting to reconnect...", error);
        };
    }
    
    // B·∫Øt ƒë·∫ßu k·∫øt n·ªëi khi trang t·∫£i xong
    document.addEventListener('DOMContentLoaded', connectWebSocket);

    // --- End WebSocket Client Logic ---

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.style.display = 'none';
      });
      document.getElementById(screenId).style.display = 'flex';
    }

    function selectTable(banNumber) {
      selectedBan = banNumber;
      document.getElementById('table-info').textContent = `B·∫°n ƒëang ·ªü B√†n ${selectedBan}`;
      showScreen('start-screen');
    }

    function startOrder() {
      if (!selectedBan) {
        showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin b√†n. Vui l√≤ng ch·ªçn l·∫°i.');
        return;
      }

      const startScreen = document.getElementById('start-screen');
      startScreen.style.display = 'none';
      
      const loadingMessage = document.createElement('div');
      loadingMessage.className = 'loading-indicator';
      loadingMessage.textContent = 'ƒêang t·∫£i trang g·ªçi m√≥n...';
      document.getElementById('main-container').appendChild(loadingMessage);

      fetch(LINKS_JSON_URL)
        .then(r => {
          if (!r.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i links.json');
          return r.json();
        })
        .then(data => {
          const url = data[selectedBan];
          if (url) {
            loadingMessage.remove();
            createIframe(url);
          } else {
            loadingMessage.remove();
            showError('Kh√¥ng t√¨m th·∫•y link cho b√†n ' + selectedBan);
            showScreen('start-screen');
          }
        })
        .catch(err => {
          loadingMessage.remove();
          showError('L·ªói t·∫£i file links.json: ' + err.message);
          showScreen('start-screen');
        });
    }

    function createIframe(url) {
      const iframeScreen = document.getElementById('iframe-screen');
      const returnButton = `<button class="return-button" onclick="clearPage()"></button>`;
      iframeScreen.innerHTML = returnButton;
      const iframe = document.createElement('iframe');
      iframe.id = 'pos-iframe';
      iframe.className = 'iframe-container';
      iframe.src = url;
      iframeScreen.appendChild(iframe);
      showScreen('iframe-screen');
    }

    function clearPage() {
      const iframeScreen = document.getElementById('iframe-screen');
      if (iframeScreen) {
        iframeScreen.innerHTML = '';
      }
      showScreen('start-screen');
    }

    function showError(message) {
      const existingError = document.querySelector('.error-message');
      if (existingError) existingError.remove();
      
      const errorMessage = document.createElement('div');
      errorMessage.className = 'error-message';
      errorMessage.textContent = message;
      document.getElementById('main-container').appendChild(errorMessage);
      setTimeout(() => errorMessage.remove(), 5000);
    }
  </script>
</body>
</html>
