<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA meta -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://placehold.co/192x192/da251d/fff?text=TN"/>
  <link rel="apple-touch-icon" href="https://placehold.co/192x192/da251d/fff?text=TN"/>
  <meta name="apple-mobile-web-app-title" content="T-NGON"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="theme-color" content="#da251d">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, sans-serif; margin:0; padding:0; background:#f3f4f6; }
    .main-container { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; width:100vw; padding:1rem; box-sizing:border-box; }
    .screen { display:none; flex-direction:column; justify-content:center; align-items:center; width:100%; height:100%; }
    #table-selection-screen { display:flex; }
    .button-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1.5rem; max-width:600px; margin:2rem auto 0; }
    .table-button { font-size:2rem; font-weight:700; padding:2rem 1rem; background:#007aff; color:#fff; border:2px solid #007aff; border-radius:.75rem; box-shadow:0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); cursor:pointer; transition:all .3s ease; }
    .table-button:hover { background:#005fbc; border-color:#005fbc; transform:translateY(-2px); }
    .start-button { font-size:2.5rem; padding:1.25rem 2.5rem; background:#007aff; color:#fff; border:none; border-radius:.75rem; box-shadow:0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); cursor:pointer; transition:all .3s ease; }
    .start-button:hover { background:#005fbc; transform:translateY(-2px); }
    .iframe-container { width:100%; height:100%; border:none; overflow:hidden; }
    .loading-indicator { font-size:1.5rem; color:#6b7280; margin-top:1rem; }
    .error-message { color:#ef4444; font-size:1.2rem; margin-top:1rem; }
    @media (max-width:640px){
      .button-grid { grid-template-columns:repeat(2,1fr); gap:1rem; }
      .table-button { font-size:1.5rem; padding:1.5rem .5rem; }
      .start-button { font-size:2rem; padding:1rem 2rem; }
    }
    .return-button { position:absolute; bottom:10px; left:10px; width:24px; height:24px; padding:0; background:transparent; border:none; cursor:pointer; z-index:100; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="main-container" id="main-container">
    <!-- M√†n ch·ªçn b√†n -->
    <div class="screen" id="table-selection-screen">
      <h2 class="text-5xl font-bold text-gray-800">T-NGON</h2>
      <p class="text-lg text-gray-600 mt-2">Vui l√≤ng ch·ªçn b√†n c·ªßa b·∫°n</p>
      <div class="button-grid">
        <script>
          for (let i = 1; i <= 15; i++) {
            document.write(`<button class="table-button" onclick="selectTable(${i})">B√†n ${i}</button>`);
          }
        </script>
      </div>
    </div>

    <!-- M√†n B·∫ÆT ƒê·∫¶U -->
    <div class="screen" id="start-screen">
      <div class="space-y-4 text-gray-800 text-center">
        <h2 class="text-5xl font-bold">T-NGON</h2>
        <p class="text-lg">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫∑t m√≥n</p>
        <div class="button-container">
          <button class="start-button" onclick="startOrder()">üçΩÔ∏è B·∫ÆT ƒê·∫¶U</button>
        </div>
        <p id="table-info" class="text-sm text-gray-500 mt-4"></p>
      </div>
    </div>

    <!-- M√†n iframe -->
    <div class="screen" id="iframe-screen">
      <button class="return-button" onclick="clearPage()"></button>
    </div>
  </div>

  <script>
    // ====== C·∫•u h√¨nh chung ======
    const LINKS_JSON_URL = "https://tngon462.github.io/QR/links.json"; // gi·ªØ nguy√™n link c·ªßa s·∫øp
    let selectedBan = null; // s·ªë b√†n hi·ªán t·∫°i

    // ====== Firebase (listener expired) ======
    const firebaseConfig = {
      apiKey: "AIzaSyB4u2G41xdGkgBC0KltleRpcg5Lwru2RIU",
      authDomain: "tngon-b37d6.firebaseapp.com",
      databaseURL: "https://tngon-b37d6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tngon-b37d6",
      storageBucket: "tngon-b37d6.firebasestorage.app",
      messagingSenderId: "580319242104",
      appId: "1:580319242104:web:6922e4327bdc8286c30a8d",
      measurementId: "G-LHEH8ZC6SL"
    };

    let fbApp = null, rtdb = null;
    let lastTs = 0;
    let currentRef = null, currentBanListening = null;

    function attachListenerFor(ban) {
      if (!rtdb) return;
      if (currentBanListening === ban) return;
      if (currentRef) currentRef.off();

      currentBanListening = ban;
      currentRef = rtdb.ref('signals/' + ban);
      console.log('[RTDB] attach listener -> signals/' + ban);

      currentRef.on('value',
        (snap) => {
          const v = snap.val();
          console.log('[RTDB] value:', v);
          if (!v) return;
          const ts = v.ts || 0;
          if (v.status === 'expired' && ts > lastTs) {
            lastTs = ts;
            if (typeof window.__updateLastTs === 'function') window.__updateLastTs(ts);
            showError(`B√†n ${ban} ƒë√£ h·∫øt h·∫°n. ƒêang quay l·∫°i m√†n h√¨nh ch√≠nh...`);
            setTimeout(clearPage, 1500);
          }
        },
        (err) => {
          console.error('[RTDB] error', err && err.code, err && err.message);
        }
      );
    }

    function connectFirebase() {
      try {
        if (!fbApp) fbApp = firebase.initializeApp(firebaseConfig);
        if (!rtdb) rtdb = firebase.database();
      } catch(e) {
        console.error('Firebase init error:', e);
      }
    }

    // ====== UI helpers ======
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'flex';
    }

    function selectTable(banNumber) {
      selectedBan = banNumber;
      document.getElementById('table-info').textContent = `B·∫°n ƒëang ·ªü B√†n ${selectedBan}`;
      showScreen('start-screen');
      attachListenerFor(selectedBan);
    }

    function startOrder() {
      if (!selectedBan) {
        showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin b√†n. Vui l√≤ng ch·ªçn l·∫°i.');
        return;
      }
      const startScreen = document.getElementById('start-screen');
      startScreen.style.display = 'none';

      const loading = document.createElement('div');
      loading.className = 'loading-indicator';
      loading.textContent = 'ƒêang t·∫£i trang g·ªçi m√≥n...';
      document.getElementById('main-container').appendChild(loading);

      fetch(LINKS_JSON_URL)
        .then(r => { if (!r.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i links.json'); return r.json(); })
        .then(data => {
          const url = data[selectedBan];
          loading.remove();
          if (url) createIframe(url);
          else { showError('Kh√¥ng t√¨m th·∫•y link cho b√†n ' + selectedBan); showScreen('start-screen'); }
        })
        .catch(err => { loading.remove(); showError('L·ªói t·∫£i file links.json: ' + err.message); showScreen('start-screen'); });
    }

    function createIframe(url) {
      const iframeScreen = document.getElementById('iframe-screen');
      iframeScreen.innerHTML = `<button class="return-button" onclick="clearPage()"></button>`;
      const iframe = document.createElement('iframe');
      iframe.id = 'pos-iframe';
      iframe.className = 'iframe-container';
      iframe.src = url;
      iframeScreen.appendChild(iframe);
      showScreen('iframe-screen');
    }

    function clearPage() {
      const iframeScreen = document.getElementById('iframe-screen');
      if (iframeScreen) iframeScreen.innerHTML = '';
      showScreen('start-screen');
    }

    function showError(msg) {
      const existing = document.querySelector('.error-message'); if (existing) existing.remove();
      const el = document.createElement('div'); el.className = 'error-message'; el.textContent = msg;
      document.getElementById('main-container').appendChild(el);
      setTimeout(() => el.remove(), 5000);
    }

    // ====== Auto select b√†n ======
    function getQueryParam(name){
      try { return new URL(window.location.href).searchParams.get(name); } catch { return null; }
    }

    async function backfillSelectedBanFromIframe(){
      try{
        if (selectedBan) return;
        const iframe = document.getElementById('pos-iframe');
        if (!iframe || !iframe.src) return;
        const r = await fetch(LINKS_JSON_URL); const data = await r.json();
        for (const [ban, url] of Object.entries(data)) {
          if (iframe.src === url) {
            selectedBan = parseInt(ban, 10);
            console.log('[AutoDetect] G√°n selectedBan =', selectedBan, 't·ª´ iframe.src');
            attachListenerFor(selectedBan);
            break;
          }
        }
      } catch(e){ console.warn('[AutoDetect] l·ªói:', e); }
    }

    // ====== Badge debug (g√≥c d∆∞·ªõi ph·∫£i) ======
    (function () {
      const badge = document.createElement('div');
      badge.id = 'debug-badge';
      badge.style.cssText = "position:fixed;right:10px;bottom:10px;background:#111;color:#fff;font:12px/1.3 system-ui;padding:8px 10px;border-radius:10px;opacity:.9;z-index:9999";
      badge.textContent = "Firebase: ch∆∞a g·∫Øn listener";
      document.addEventListener('DOMContentLoaded', () => document.body.appendChild(badge));
      setInterval(() => {
        if (!selectedBan) { badge.textContent = "Ch∆∞a ch·ªçn b√†n"; return; }
        badge.textContent = `ƒêang nghe: signals/${selectedBan} ‚Ä¢ lastTs=${window.__lastTs||0}`;
      }, 800);
      window.__updateLastTs = (ts) => { window.__lastTs = ts; };
    })();

    // ====== Kh·ªüi ƒë·ªông ======
    document.addEventListener('DOMContentLoaded', () => {
      connectFirebase();

      // T·ª± ch·ªçn b√†n n·∫øu c√≥ ?ban=...
      const qBan = getQueryParam('ban');
      if (qBan) {
        const n = parseInt(qBan, 10);
        if (!isNaN(n)) {
          // ch·ªù 1 tick cho c√°c h√†m ƒë√£ s·∫µn s√†ng
          setTimeout(() => { selectTable(n); startOrder(); }, 100);
        }
      }

      // Ph√≤ng tr∆∞·ªùng h·ª£p selectedBan b·ªã m·∫•t, s·∫Ω d√≤ ng∆∞·ª£c t·ª´ iframe
      setInterval(backfillSelectedBanFromIframe, 1000);
    });
  </script>
</body>
</html>
