<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* S·ª≠ d·ª•ng font Inter cho to√†n b·ªô trang */
    body {
      font-family: 'Inter', sans-serif;
      text-align: center;
      background-color: #f3f4f6; /* M√†u n·ªÅn x√°m nh·∫°t */
    }
    .container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 1rem;
    }
    .button-container {
      margin-top: 2rem;
    }
    .start-button {
      font-size: 2.5rem;
      padding: 1.25rem 2.5rem;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .start-button:hover {
      background-color: #005fbc;
      transform: translateY(-2px);
    }
    .start-button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .iframe-container {
      width: 100%;
      height: 100vh;
      border: none;
      overflow: hidden;
    }
    .loading-indicator {
        font-size: 1.5rem;
        color: #6b7280;
        margin-top: 1rem;
    }
    .error-message {
        color: #ef4444;
        font-size: 1.2rem;
        margin-top: 1rem;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container" id="main-container">
    <div class="space-y-4 text-gray-800" id="start-screen">
      <h2 class="text-5xl font-bold">T-NGON</h2>
      <p class="text-lg">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫∑t m√≥n</p>
      <div class="button-container">
        <button class="start-button" onclick="startOrder()">üçΩÔ∏è B·∫ÆT ƒê·∫¶U</button>
      </div>
      <p id="table-info" class="text-sm text-gray-500 mt-4"></p>
    </div>
  </div>

  <script>
    // L·∫•y tham s·ªë 'ban' t·ª´ URL
    const params = new URLSearchParams(window.location.search);
    const ban = params.get('ban');

    // Hi·ªÉn th·ªã s·ªë b√†n ƒëang ho·∫°t ƒë·ªông
    const tableInfo = document.getElementById('table-info');
    if (ban) {
      tableInfo.textContent = `B·∫°n ƒëang ·ªü B√†n ${ban}`;
    }

    let checkInterval; // Bi·∫øn l∆∞u tr·ªØ ID c·ªßa interval

    function startOrder() {
      if (!ban) {
        alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin b√†n. Vui l√≤ng th·ª≠ l·∫°i v·ªõi URL c√≥ ch·ª©a "?ban=..."');
        return;
      }

      // ·∫®n m√†n h√¨nh b·∫Øt ƒë·∫ßu v√† hi·ªÉn th·ªã loading
      const startScreen = document.getElementById('start-screen');
      const mainContainer = document.getElementById('main-container');
      startScreen.style.display = 'none';

      const loadingMessage = document.createElement('div');
      loadingMessage.className = 'loading-indicator';
      loadingMessage.textContent = 'ƒêang t·∫£i trang g·ªçi m√≥n...';
      mainContainer.appendChild(loadingMessage);

      // T·∫£i links.json v√† t·∫°o iframe
      fetch('links.json')
        .then(r => {
          if (!r.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i links.json');
          return r.json();
        })
        .then(data => {
          const url = data[ban];
          if (url) {
            loadingMessage.remove(); // X√≥a loading message
            createIframe(url);
          } else {
            loadingMessage.remove();
            showError('Kh√¥ng t√¨m th·∫•y link cho b√†n ' + ban);
            startScreen.style.display = 'block';
          }
        })
        .catch(err => {
          loadingMessage.remove();
          showError('L·ªói t·∫£i file links.json: ' + err.message);
          startScreen.style.display = 'block';
        });
    }

    function createIframe(url) {
      const iframe = document.createElement('iframe');
      iframe.id = 'pos-iframe';
      iframe.className = 'iframe-container';
      iframe.src = url;
      document.body.appendChild(iframe);

      // B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i h·∫øt h·∫°n trong iframe
      checkInterval = setInterval(() => {
        checkIframeContent(iframe);
      }, 5000); // Ki·ªÉm tra m·ªói 5 gi√¢y
    }
    
    function checkIframeContent(iframe) {
        try {
            // L·∫•y n·ªôi dung c·ªßa iframe. C·∫ßn c·∫©n th·∫≠n v·ªõi l·ªói Cross-Origin.
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (iframeDoc) {
                const bodyText = iframeDoc.body.textContent.toLowerCase();
                
                // Ki·ªÉm tra c√°c t·ª´ kh√≥a h·∫øt h·∫°n trong n·ªôi dung trang
                if (bodyText.includes('h·∫øt h·∫°n') || bodyText.includes('h·∫øt hi·ªáu l·ª±c') || bodyText.includes('l·ªói')) {
                    console.log('Ph√°t hi·ªán trang h·∫øt h·∫°n. Quay l·∫°i m√†n h√¨nh b·∫Øt ƒë·∫ßu.');
                    clearPage();
                }
            }
        } catch (e) {
            // L·ªói Cross-Origin. N·∫øu kh√¥ng th·ªÉ truy c·∫≠p n·ªôi dung, ta kh√¥ng th·ªÉ ki·ªÉm tra.
            // Trong tr∆∞·ªùng h·ª£p n√†y, ta gi·∫£ ƒë·ªãnh iframe v·∫´n ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.
            console.log('Kh√¥ng th·ªÉ truy c·∫≠p n·ªôi dung iframe do l·ªói Cross-Origin. Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i.');
        }
    }

    function clearPage() {
      // D·ª´ng v√≤ng l·∫∑p ki·ªÉm tra
      if (checkInterval) {
        clearInterval(checkInterval);
      }

      // X√≥a iframe hi·ªán t·∫°i
      const iframe = document.getElementById('pos-iframe');
      if (iframe) {
        iframe.remove();
      }

      // Hi·ªÉn th·ªã l·∫°i m√†n h√¨nh b·∫Øt ƒë·∫ßu
      const startScreen = document.getElementById('start-screen');
      startScreen.style.display = 'block';
    }

    function showError(message) {
      const errorMessage = document.createElement('div');
      errorMessage.className = 'error-message';
      errorMessage.textContent = message;
      document.getElementById('main-container').appendChild(errorMessage);
    }
  </script>
</body>
</html>
