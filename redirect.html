<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>T-NGON</title>
<style>
  html, body {
    margin:0; padding:0; height:100%; width:100%;
    font-family:sans-serif;
    background:#fff; color:#000;
  }
  #main-container { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; }
  .ban-list { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
  .ban-item { padding:15px 20px; background:#f0f0f0; border-radius:8px; cursor:pointer; font-size:20px; }
  #slideshow { display:none; width:100%; height:100%; background:#fff; position:relative; overflow:hidden; }
  #slideshow img, #slideshow video { max-width:100%; max-height:100%; object-fit:contain; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); }
  .loading-indicator { color:#000; font-size:20px; }
  iframe { border:none; width:100%; height:100%; }
</style>
</head>
<body>

<div id="main-container">
  <div id="start-screen">
    <h2 class="text-5xl font-bold">T-NGON</h2>
    <div class="ban-list" id="ban-list"></div>
  </div>
  <div id="slideshow"></div>
</div>

<script>
const GH_OWNER = "tngon462";
const GH_REPO = "slide";
const GH_BRANCH = "main";
const GH_FOLDER = "slides";
const SLIDE_DEFAULT_DURATION = "5s";
const SLIDE_SHUFFLE = false;
const RELOAD_INTERVAL_MS = 60000;

let slides = [];
let cumDurations = [];
let totalDuration = 0;
let cycleStartTs = null;
let currentIndex = -1;
let slideshowEnabled = false;

function ms(s){ if(typeof s==="number") return s*1000; if(typeof s==="string"&&s.endsWith("s")) return parseFloat(s)*1000; return parseFloat(s)||5000; }
function isVideoUrl(url){ return /\.(mp4|webm|mov|m4v)$/i.test(url); }
function nowServerMs(){ return Date.now(); }

async function loadSlidesFromManifest(){
  const base = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${GH_FOLDER}/`;
  const url  = base + "manifest.json?cb=" + Date.now();
  let res;
  try { res = await fetch(url, { cache: "no-store" }); } catch { return false; }
  if (!res.ok) return false;
  let arr;
  try { arr = await res.json(); } catch { return false; }
  if (!Array.isArray(arr) || !arr.length) return false;

  const allowed = /\.(jpe?g|png|gif|mp4|webm|mov|m4v)$/i;
  slides = arr
    .map(item => {
      if (typeof item === "string") return { src: base + item, name: item, duration: SLIDE_DEFAULT_DURATION };
      if (item && typeof item === "object" && item.src) {
        const src = item.src.startsWith("http") ? item.src : (base + item.src);
        return { src, name: item.src, duration: item.duration || SLIDE_DEFAULT_DURATION };
      }
      return null;
    })
    .filter(Boolean)
    .filter(it => allowed.test(it.name))
    .map(it => ({ type: isVideoUrl(it.src) ? "video" : "image", src: it.src, duration: it.duration }));

  if (SLIDE_SHUFFLE) {
    for (let i = slides.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [slides[i], slides[j]] = [slides[j], slides[i]];
    }
  }

  cumDurations = [];
  totalDuration = 0;
  for (const it of slides){ totalDuration += ms(it.duration); cumDurations.push(totalDuration); }

  return slides.length > 0;
}

function computeIndexAndOffset(nowMs){
  const elapsed = (nowMs - cycleStartTs) % totalDuration;
  let idx = 0;
  while (elapsed >= cumDurations[idx]) idx++;
  const prevCum = idx===0 ? 0 : cumDurations[idx-1];
  return { idx, offsetMs: elapsed - prevCum };
}

function swapStage(el){
  const s = document.getElementById("slideshow");
  s.innerHTML = "";
  s.appendChild(el);
}

function showImage(src){
  const img = document.createElement("img");
  img.src = src;
  swapStage(img);
}

function showVideo(src, offsetMs){
  const vid = document.createElement("video");
  vid.src = src;
  vid.muted = true;
  vid.playsInline = true;
  vid.autoplay = true;
  vid.preload = "auto";
  vid.controls = false;
  vid.addEventListener("loadedmetadata", () => {
    try {
      const offSec = Math.min((offsetMs||0)/1000, Math.max(0,(vid.duration||0)-0.05));
      if (isFinite(offSec) && offSec > 0) vid.currentTime = offSec;
    } catch(_) {}
    vid.play().catch(()=>{});
  });
  swapStage(vid);
}

function renderByClock(){
  if (!slides.length) return;
  const { idx, offsetMs } = computeIndexAndOffset(nowServerMs());
  if (idx !== currentIndex){
    currentIndex = idx;
    const item = slides[idx];
    if (item.type === "video") showVideo(item.src, offsetMs);
    else showImage(item.src);
  }
}

function startSyncLoop(){
  setInterval(() => {
    renderByClock();
  }, 1000);
}

async function initSlideshow(){
  const hasSlides = await loadSlidesFromManifest();
  if (!hasSlides) {
    slideshowEnabled = false;
    showScreen("start-screen");
    return;
  }
  slideshowEnabled = true;
  cycleStartTs = nowServerMs();
  showScreen("slideshow");
  renderByClock();
  startSyncLoop();
}

function showScreen(id){
  document.getElementById("start-screen").style.display = id==="start-screen" ? "block" : "none";
  document.getElementById("slideshow").style.display = id==="slideshow" ? "block" : "none";
}

// ------------ Màn chọn bàn + logic cũ ------------
const bans = Array.from({length: 15}, (_,i)=>i+1);
const banList = document.getElementById("ban-list");
let selectedBan = null;

bans.forEach(b => {
  const div = document.createElement("div");
  div.className = "ban-item";
  div.textContent = "Bàn " + b;
  div.onclick = () => {
    selectedBan = "ban" + b;
    if (slideshowEnabled) {
      // Nếu đang slideshow, chạm vào thì quay lại màn start
      showScreen("start-screen");
    } else {
      startOrder();
    }
  };
  banList.appendChild(div);
});

function startOrder(){
  if (!selectedBan) { return; }
  document.getElementById("start-screen").style.display = "none";
  const loading = document.createElement("div");
  loading.className = "loading-indicator";
  loading.textContent = "Đang tải...";
  document.getElementById("main-container").appendChild(loading);
  fetch("links.json")
    .then(res => res.json())
    .then(data => {
      const url = data[selectedBan];
      loading.remove();
      if (url) createIframe(url); else showScreen("start-screen");
    })
    .catch(_err => { loading.remove(); showScreen("start-screen"); });
}

function createIframe(url){
  const iframe = document.createElement("iframe");
  iframe.src = url;
  document.getElementById("main-container").innerHTML = "";
  document.getElementById("main-container").appendChild(iframe);
}

// ------------ Chạy ------------
initSlideshow();
</script>
</body>
</html>
