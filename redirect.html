<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA meta -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="https://placehold.co/192x192/da251d/fff?text=TN" />
  <link rel="apple-touch-icon" href="https://placehold.co/192x192/da251d/fff?text=TN" />
  <meta name="apple-mobile-web-app-title" content="T-NGON" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#da251d" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    body { font-family: "Inter", system-ui, sans-serif; margin: 0; padding: 0; background: #f3f4f6; }
    .main-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; width: 100vw; padding: 1rem; box-sizing: border-box; }
    .screen { display: none; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; }
    #table-selection-screen { display: flex; }
    .button-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; max-width: 600px; margin: 2rem auto 0; }
    .table-button { font-size: 2rem; font-weight: 700; padding: 2rem 1rem; background: #007aff; color: #fff; border: 2px solid #007aff; border-radius: 0.75rem; cursor: pointer; transition: all .2s ease; }
    .table-button:active { transform: translateY(1px); }
    .start-button { font-size: 2.5rem; padding: 1.25rem 2.5rem; background: #007aff; color: #fff; border: none; border-radius: 0.75rem; cursor: pointer; transition: all .2s ease; }
    .start-button:active { transform: translateY(1px); }
    .iframe-container { width: 100%; height: 100%; border: none; overflow: hidden; }
    .return-button { position: absolute; bottom: 10px; left: 10px; width: 24px; height: 24px; background: transparent; border: none; cursor: pointer; z-index: 100; }
    #start-slideshow-screen { position: relative; width:100%; height:100%; background:#ffffff; overflow:hidden; }
    .slide-stage { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#ffffff; }
    .slide-stage img, .slide-stage video { max-width:100%; max-height:100%; object-fit:contain; background:#ffffff; }
    .tap-overlay { position:absolute; inset:0; z-index:10; cursor:pointer; }
    .slide-status { position:absolute; top:10px; right:10px; z-index:20; background: rgba(220, 38, 38, 0.9); color:#fff; padding: 6px 10px; border-radius: 6px; font-size: 12px; display:none; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="main-container" id="main-container">
    <div class="screen" id="table-selection-screen">
      <h2 class="text-5xl font-bold">T-NGON</h2>
      <p class="text-lg mt-2">Vui l√≤ng ch·ªçn b√†n c·ªßa b·∫°n</p>
      <div class="button-grid" id="table-buttons"></div>
    </div>

    <div class="screen" id="start-screen">
      <h2 class="text-5xl font-bold">T-NGON</h2>
      <p class="mt-2">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫∑t m√≥n</p>
      <button class="start-button" onclick="startOrder()">üçΩÔ∏è B·∫ÆT ƒê·∫¶U</button>
      <p id="table-info" class="text-sm mt-4"></p>
    </div>

    <div class="screen" id="start-slideshow-screen">
      <div class="tap-overlay" onclick="showScreen('start-screen')"></div>
      <div class="slide-stage" id="slide-stage"></div>
      <div id="slide-status" class="slide-status"></div>
    </div>

    <div class="screen" id="iframe-screen"></div>
  </div>

  <script>
    const LINKS_JSON_URL = "https://tngon462.github.io/QR/links.json";
    let selectedBan = null;

    const firebaseConfig = { /* gi·ªØ nguy√™n c·∫•u h√¨nh Firebase c·ªßa s·∫øp */ };
    let fbApp = null, rtdb = null, currentRef = null, lastTs = 0, pollInitTs = null;
    let serverOffsetMs = 0, serverClockReady = false;
    function nowServerMs(){ return Date.now() + (Number(serverOffsetMs)||0); }

    function connectFirebase() {
      if (!fbApp) fbApp = firebase.initializeApp(firebaseConfig);
      if (!rtdb) rtdb = firebase.database();
      rtdb.ref(".info/serverTimeOffset").on("value", snap => {
        serverOffsetMs = Number(snap.val()||0);
        serverClockReady = true;
      });
    }

    function attachListenerFor(ban) {
      if (!rtdb) return;
      if (currentRef) currentRef.off();
      currentRef = rtdb.ref("signals/" + ban);
      let initialized = false, firstTs = 0;
      currentRef.on("value", snap => {
        const v = snap.val(); if (!v) return;
        const ts = v.ts || 0;
        if (!initialized) { initialized = true; firstTs = ts; return; }
        if (v.status === "expired" && ts > lastTs && ts > firstTs) { lastTs = ts; clearPage(); }
      });
    }

    async function pollExpiredFallback(){
      try{
        if (!selectedBan) return;
        const url = firebaseConfig.databaseURL.replace(/\/$/,"") + "/signals/" + selectedBan + ".json?cb=" + Date.now();
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) return;
        const v = await res.json(); if (!v) return;
        const ts = v.ts || 0;
        if (pollInitTs === null) { pollInitTs = ts; return; }
        if (v.status === "expired" && ts > lastTs && ts > pollInitTs) { lastTs = ts; clearPage(); }
      }catch{}
    }
    setInterval(pollExpiredFallback, 3000);

    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.style.display = "none");
      document.getElementById(id).style.display = "flex";
      if (id === "start-screen") resetIdleTimer();
    }

    function selectTable(banNumber) {
      selectedBan = banNumber; pollInitTs = null;
      document.getElementById("table-info").textContent = `B·∫°n ƒëang ·ªü B√†n ${selectedBan}`;
      attachListenerFor(selectedBan);
      initSlidesThenMaybeShow();
    }

    function startOrder() {
      if (!selectedBan) return;
      stopSlideLoop();
      fetch(LINKS_JSON_URL)
        .then(r => r.json())
        .then(data => {
          const url = data[selectedBan] ?? data[String(selectedBan)];
          if (url) createIframe(url); else showScreen("start-screen");
        })
        .catch(() => showScreen("start-screen"));
    }

    function createIframe(url) {
      const iframeScreen = document.getElementById("iframe-screen");
      iframeScreen.innerHTML = `<button class="return-button" onclick="clearPage()"></button>`;
      const iframe = document.createElement("iframe");
      iframe.className = "iframe-container";
      iframe.src = url;
      iframeScreen.appendChild(iframe);
      showScreen("iframe-screen");
    }

    function clearPage() {
      stopSlideLoop();
      document.getElementById("iframe-screen").innerHTML = "";
      showScreen("start-screen");
    }

    const GH_OWNER = "tngon462", GH_REPO = "slide", GH_BRANCH = "main", GH_FOLDER = "slides";
    const DEFAULT_DUR = 8;
    const SLIDES_EPOCH_MS = Date.UTC(2024,0,1,0,0,0);

    let slides = [], edgesMs = [], periodMs = 0, currentIndex = -1, loopTimer = null, kickTimer = null;

    function setSlideStatus(msg){
      const box = document.getElementById("slide-status");
      if (msg) { box.textContent = msg; box.style.display = "block"; }
      else box.style.display = "none";
    }

    function msFromDur(d){
      return (typeof d === "number" ? d : DEFAULT_DUR) * 1000;
    }

    function isVideoUrl(u){
      try { const ext = (new URL(u)).pathname.split('.').pop().toLowerCase();
        return ['mp4','webm','ogg','mov','m4v'].includes(ext);
      } catch { return false; }
    }

    function swapStage(el){
      const stage = document.getElementById("slide-stage");
      stage.innerHTML = "";
      stage.appendChild(el);
    }

    function showImage(src){
      const img = document.createElement("img");
      img.src = src;
      swapStage(img);
    }

    function showVideo(src, offsetMs){
      const v = document.createElement("video");
      v.src = src; v.muted = true; v.playsInline = true; v.autoplay = true;
      v.addEventListener("loadedmetadata", () => {
        const offSec = Math.min((offsetMs||0)/1000, v.duration||0);
        if (offSec > 0) v.currentTime = offSec;
        v.play();
      });
      swapStage(v);
    }

    function buildTimeline(){
      edgesMs = []; periodMs = 0;
      for (const s of slides){ periodMs += msFromDur(s.duration); edgesMs.push(periodMs); }
    }

    function indexFromOffset(offsetMs){
      let idx = edgesMs.findIndex(edge => offsetMs < edge);
      if (idx < 0) idx = slides.length - 1;
      const slideDur = msFromDur(slides[idx].duration);
      const startOf = edgesMs[idx] - slideDur;
      const inside = offsetMs - startOf;
      return { idx, inside };
    }

    function renderByEpoch(){
      if (!slides.length || !periodMs) return;
      const t = nowServerMs() - SLIDES_EPOCH_MS;
      const offset = ((t % periodMs) + periodMs) % periodMs;
      const { idx, inside } = indexFromOffset(offset);
      if (idx !== currentIndex){
        currentIndex = idx;
        const it = slides[idx];
        if (it.type === "video") showVideo(it.src, inside);
        else showImage(it.src);
      }
    }

    function startSlideLoop(){
      stopSlideLoop();
      loopTimer = setInterval(renderByEpoch, 200);
      kickTimer = setInterval(()=>{ currentIndex = -1; renderByEpoch(); }, 5000);
    }

    function stopSlideLoop(){
      clearInterval(loopTimer); loopTimer = null;
      clearInterval(kickTimer); kickTimer = null;
      currentIndex = -1;
    }

    async function loadSlidesFromManifest(){
      const base = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${GH_FOLDER}/`;
      const url  = base + "manifest.json?cb=" + Date.now();
      try{
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) return false;
        let arr = await res.json();
        if (!Array.isArray(arr)) return false;
        const allowed = /\.(jpe?g|png|gif|mp4|webm|mov|m4v)$/i;
        const items = arr.map(item => {
          if (typeof item === "string") return { src: base + item, duration: DEFAULT_DUR };
          if (item && typeof item === "object" && item.src) {
            const src = item.src.startsWith("http") ? item.src : base + item.src;
            return { src, duration: Number(item.duration)||DEFAULT_DUR };
          }
          return null;
        }).filter(Boolean).filter(it => allowed.test(it.src));
        slides = items.map(it => ({ type: isVideoUrl(it.src) ? "video" : "image", src: it.src, duration: it.duration }));
        buildTimeline(); return true;
      } catch { return false; }
    }

    async function initSlidesThenMaybeShow(){
      if (!slides.length) {
        let ok = await loadSlidesFromManifest();
        if (!ok) { await new Promise(r=>setTimeout(r,800)); ok = await loadSlidesFromManifest(); }
        if (!ok) { showScreen("start-screen"); return; }
      }
      if (!serverClockReady) await new Promise(r=>setTimeout(r,300));
      startSlideLoop();
      showScreen("start-slideshow-screen");
    }

    const IDLE_MS = 59000;
    let idleTimer = null;
    function isOnStartScreen(){ return document.getElementById("start-screen").style.display !== "none"; }
    function resetIdleTimer(){
      clearTimeout(idleTimer);
      if (isOnStartScreen()) idleTimer = setTimeout(() => initSlidesThenMaybeShow(), IDLE_MS);
    }
    ["touchstart","touchmove","mousedown","mousemove","keydown"].forEach(evt => {
      window.addEventListener(evt, resetIdleTimer, { passive:true });
    });

    document.addEventListener("DOMContentLoaded", () => {
      connectFirebase();
      const wrap = document.getElementById("table-buttons");
      for (let i = 1; i <= 15; i++) {
        const btn = document.createElement("button");
        btn.className = "table-button";
        btn.textContent = "B√†n " + i;
        btn.onclick = () => selectTable(i);
        wrap.appendChild(btn);
      }
      showScreen("table-selection-screen");
    });
  </script>
</body>
</html>