<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>T-NGON</title>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
  body,html{margin:0;padding:0;height:100%;font-family:sans-serif}
  .screen{display:none;align-items:center;justify-content:center;height:100%;flex-direction:column}
  #table-selection-screen{display:flex}
  .btn{padding:12px 20px;background:#ef4444;color:#fff;margin:6px;border-radius:8px;font-size:18px}
  .tap-overlay{position:absolute;inset:0;z-index:10;cursor:pointer;}
  .slide-status{position:absolute;top:10px;right:10px;z-index:20;background:rgba(220,38,38,.9);color:#fff;padding:6px 10px;border-radius:6px;font-size:12px;display:none;max-width:70vw;line-height:1.3;}

  /* === LỚP PHỦ ĐEN: điều khiển từ xa qua Firebase control/screen === */
  #tngon-sleep {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 2147483647; /* che tất cả */
    display: none;
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
  }
  </style>
</head>
<body>
  <div id="table-selection-screen" class="screen">
    <h2 class="text-5xl font-bold">T-NGON</h2>
    <p>Vui lòng chọn bàn của bạn</p>
    <div id="table-buttons"></div>
  </div>

  <div id="start-slideshow-screen" class="screen">
    <h2 class="text-5xl font-bold">T-NGON</h2>
    <p>Nhấn nút bên dưới để bắt đầu đặt món</p>
    <button class="btn" onclick="startOrder()">️BẮT ĐẦU</button>
  </div>

  <script>
  // ==== Firebase connect ====
  let fbApp=null,rtdb=null,serverOffsetMs=0,serverClockReady=false;
  function connectFirebase(){
    if(!fbApp) fbApp=firebase.initializeApp(firebaseConfig);
    if(!rtdb) rtdb=firebase.database();
    rtdb.ref(".info/serverTimeOffset").on("value",snap=>{
      serverOffsetMs=Number(snap.val()||0);
      serverClockReady=true;
    });

    // login ẩn danh
    if(!firebase.auth().currentUser){
      firebase.auth().signInAnonymously().catch(e=>console.error("Auth failed:",e));
    }
    firebase.auth().onAuthStateChanged(()=>{
      if(!rtdb){
        rtdb=firebase.database();
        rtdb.ref(".info/serverTimeOffset").on("value",snap=>{
          serverOffsetMs=Number(snap.val()||0);
          serverClockReady=true;
        });
      }
    });
  }

  // ==== Slideshow cơ bản ====
  const GH_FOLDER="slides";
  const DEFAULT_DUR=8;
  const SLIDES_EPOCH_MS=Date.UTC(2024,0,1,0,0,0);
  let slides=[],edgesMs=[],periodMs=0,currentIndex=-1;
  let loopTimer=null,kickTimer=null,manifestChecked=false,slidesAvailable=false;

  function indexFromOffset(offset){
    for(let i=0;i<edgesMs.length;i++) if(offset<edgesMs[i]) return {idx:i,inside:offset};
    return {idx:0,inside:0};
  }
  function nowServerMs(){ return Date.now()+serverOffsetMs; }
  function renderByEpoch(){
    if(!slides.length||!periodMs)return;
    const t=nowServerMs()-SLIDES_EPOCH_MS;
    const offset=((t%periodMs)+periodMs)%periodMs;
    const {idx}=indexFromOffset(offset);
    if(idx!==currentIndex){ currentIndex=idx; /* hiển thị slide ở đây nếu cần */ }
  }
  function startSlideLoop(){
    stopSlideLoop();
    loopTimer=setInterval(renderByEpoch,200);
    kickTimer=setInterval(()=>{currentIndex=-1;renderByEpoch();},5000);
  }
  function stopSlideLoop(){ clearInterval(loopTimer);clearInterval(kickTimer); }

  async function initSlidesThenMaybeShow(){
    let ok=false;
    if(!manifestChecked){ ok=await loadSlidesFromManifest(); manifestChecked=true;slidesAvailable=ok;}
    else ok=slidesAvailable;
    if(ok){ if(!serverClockReady) await new Promise(r=>setTimeout(r,300)); startSlideLoop(); showScreen("start-slideshow-screen"); }
    else { showScreen("table-selection-screen"); }
  }

  function showScreen(id){ document.querySelectorAll(".screen").forEach(sc=>sc.style.display="none"); document.getElementById(id).style.display="flex"; }

  // ==== Table select ====
  function selectTable(n){ window.selectedBan=n; }
  function startOrder(){ /* gọi món */ }

  function getQueryParam(k){ return new URLSearchParams(location.search).get(k); }
  function backfillSelectedBanFromIframe(){}

  document.addEventListener("DOMContentLoaded",()=>{
    connectFirebase();
    const wrap=document.getElementById("table-buttons");
    for(let i=1;i<=15;i++){ const btn=document.createElement("button"); btn.className="btn"; btn.textContent="Bàn "+i; btn.onclick=()=>{selectTable(i); startOrder();}; wrap.appendChild(btn);}
    const qBan=getQueryParam("ban"); if(qBan){const n=parseInt(qBan,10);if(!isNaN(n))setTimeout(()=>{selectTable(n);startOrder();},100);}
    setInterval(backfillSelectedBanFromIframe,1000);
  });
  </script>

  <!-- ============== LISTENER: nhận lệnh ON/OFF màn hình từ admin ============== -->
  <script>
  (function(){
    const sleepLayer=document.createElement('div');
    sleepLayer.id='tngon-sleep';
    document.body.appendChild(sleepLayer);

    let globalScreen='on';
    let tableScreen='on';
    let tableRef=null;

    function applyEffective(){
      const off=(globalScreen==='off')||(tableScreen==='off');
      sleepLayer.style.display= off ? 'block':'none';
      document.documentElement.style.overflow= off ? 'hidden':'';
      document.body.style.overflow= off ? 'hidden':'';
    }

    function listenGlobal(){
      try{
        const db=firebase.database();
        db.ref('control/screen').on('value',snap=>{
          globalScreen=(snap && snap.val())?String(snap.val()).toLowerCase():'on';
          if(!['on','off'].includes(globalScreen)) globalScreen='on';
          applyEffective();
        });
      }catch(e){console.error(e);}
    }

    function listenPerTable(ban){
      try{
        const db=firebase.database();
        if(tableRef) tableRef.off();
        if(!ban){tableScreen='on';applyEffective();return;}
        tableRef=db.ref('control/tables/'+ban+'/screen');
        tableRef.on('value',snap=>{
          tableScreen=(snap && snap.val())?String(snap.val()).toLowerCase():'on';
          if(!['on','off'].includes(tableScreen)) tableScreen='on';
          applyEffective();
        });
      }catch(e){}
    }

    const _selectTableOrig=window.selectTable;
    window.selectTable=function(banNumber){
      _selectTableOrig.call(this,banNumber);
      listenPerTable(banNumber);
    };

    document.addEventListener('DOMContentLoaded',()=>{
      setTimeout(()=>{
        listenGlobal();
        if(window.selectedBan) listenPerTable(window.selectedBan);
      },50);
    });
  })();
  </script>
</body>
</html>
