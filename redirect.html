/* ----------------- Idle auto return ----------------- */
const IDLE_MS_START  = 59000;   // 59s ở màn start-screen → slideshow
const IDLE_MS_IFRAME = 120000;  // 2 phút ở màn iframe → quay về start
let idleTimer = null;

function isOnStartScreen(){
  const el = document.getElementById("start-screen");
  return el && el.style.display !== "none";
}
function isOnIframeScreen(){
  const el = document.getElementById("iframe-screen");
  return el && el.style.display !== "none";
}

function resetIdleTimer(){
  if (idleTimer) { clearTimeout(idleTimer); idleTimer = null; }

  if (isOnStartScreen()) {
    idleTimer = setTimeout(async () => {
      await initSlidesThenMaybeShow();
    }, IDLE_MS_START);
  } else if (isOnIframeScreen()) {
    idleTimer = setTimeout(() => {
      clearPage(); // quay lại start-screen
    }, IDLE_MS_IFRAME);
  }
}

// reset timer khi thao tác bên ngoài
["touchstart","touchmove","mousedown","mousemove","keydown"].forEach(evt => {
  window.addEventListener(evt, () => { resetIdleTimer(); }, { passive:true });
});

// reset timer cả khi thao tác bên trong iframe
function attachIframeActivityListener(iframe){
  try {
    const doc = iframe.contentWindow.document;
    ["touchstart","touchmove","mousedown","mousemove","keydown","scroll"].forEach(evt => {
      doc.addEventListener(evt, () => { resetIdleTimer(); }, { passive:true });
    });
  } catch(e) {
    // Nếu cross-origin thì không bắt được
    console.warn("Không thể attach listener trong iframe:", e);
  }
}

// Khi tạo iframe gọi món thì gắn thêm listener
function createIframe(url) {
  const iframeScreen = document.getElementById("iframe-screen");
  iframeScreen.innerHTML = `<button class="return-button" onclick="clearPage()"></button>`;
  const iframe = document.createElement("iframe");
  iframe.id = "pos-iframe";
  iframe.className = "iframe-container";
  iframe.src = url;
  iframe.onload = () => { attachIframeActivityListener(iframe); resetIdleTimer(); };
  iframeScreen.appendChild(iframe);
  showScreen("iframe-screen");
}