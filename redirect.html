<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA meta -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="https://placehold.co/192x192/da251d/fff?text=TN" />
  <link rel="apple-touch-icon" href="https://placehold.co/192x192/da251d/fff?text=TN" />
  <meta name="apple-mobile-web-app-title" content="T-NGON" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#da251d" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    body { font-family: "Inter", system-ui, sans-serif; margin: 0; padding: 0; background: #f3f4f6; }
    .main-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; width: 100vw; padding: 1rem; box-sizing: border-box; }
    .screen { display: none; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; }
    #table-selection-screen { display: flex; } /* Giữ nguyên: mở app là thấy màn chọn bàn */
    .button-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; max-width: 600px; margin: 2rem auto 0; }
    .table-button { font-size: 2rem; font-weight: 700; padding: 2rem 1rem; background: #007aff; color: #fff; border: 2px solid #007aff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); cursor: pointer; transition: all .2s ease; }
    .table-button:active { transform: translateY(1px); }
    .start-button { font-size: 2.5rem; padding: 1.25rem 2.5rem; background: #007aff; color: #fff; border: none; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); cursor: pointer; transition: all .2s ease; }
    .start-button:active { transform: translateY(1px); }
    .iframe-container { width: 100%; height: 100%; border: none; overflow: hidden; }
    .loading-indicator { font-size: 1.5rem; color: #6b7280; margin-top: 1rem; }
    .error-message { color: #ef4444; font-size: 1.2rem; margin-top: 1rem; }
    .return-button { position: absolute; bottom: 10px; left: 10px; width: 24px; height: 24px; padding: 0; background: transparent; border: none; cursor: pointer; z-index: 100; }

    @media (max-width: 640px) {
      .button-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
      .table-button { font-size: 1.5rem; padding: 1.5rem .5rem; }
      .start-button { font-size: 2rem; padding: 1rem 2rem; }
    }

    /* ===== Slideshow cho màn START (thay nút BẮT ĐẦU) ===== */
    #start-screen { position: relative; width:100%; height:100%; background:#000; overflow:hidden; display:flex; }
    .slide-stage { position: absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#000; }
    .slide-stage img, .slide-stage video { max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; }
    .slide-overlay { position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center; pointer-events:none;
      background: linear-gradient(180deg, rgba(0,0,0,0) 60%, rgba(0,0,0,0.55) 100%); }
    .slide-caption { color:#fff; text-align:center; font-size:1rem; padding:1rem 1.25rem; max-width:90vw; }
    .tap-to-start { position:absolute; inset:0; cursor:pointer; }
    .tap-hint { position:absolute; bottom:32px; right:32px; background:rgba(0,0,0,.55); color:#fff; padding:.5rem .75rem; border-radius:.5rem;
      font-weight:600; font-size:.95rem; pointer-events:none; user-select:none; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="main-container" id="main-container">
    <!-- Màn chọn bàn (GIỮ NGUYÊN) -->
    <div class="screen" id="table-selection-screen">
      <h2 class="text-5xl font-bold text-gray-800">T-NGON</h2>
      <p class="text-lg text-gray-600 mt-2">Vui lòng chọn bàn của bạn</p>
      <div class="button-grid" id="table-buttons"></div>
    </div>

    <!-- Màn START: THAY nút BẮT ĐẦU bằng SLIDESHOW (chạm để vào startOrder) -->
    <div class="screen" id="start-screen">
      <div class="tap-to-start" onclick="startOrder()" title="Chạm để bắt đầu"></div>
      <div class="slide-stage" id="slide-stage"></div>
      <div class="slide-overlay"><div class="slide-caption" id="slide-caption"></div></div>
      <div class="tap-hint">Chạm để bắt đầu đặt món</div>
      <p id="table-info" class="text-sm text-gray-300 absolute top-3 left-4 bg-black/40 px-2 py-1 rounded"></p>
    </div>

    <!-- Màn iframe (GIỮ NGUYÊN) -->
    <div class="screen" id="iframe-screen">
      <button class="return-button" onclick="clearPage()"></button>
    </div>
  </div>

  <script>
    /* ----------------- Config chung (GIỮ NGUYÊN) ----------------- */
    const LINKS_JSON_URL = "https://tngon462.github.io/QR/links.json";
    let selectedBan = null;

    /* ----------------- Firebase (GIỮ NGUYÊN) ----------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB4u2G41xdGkgBC0KltleRpcg5Lwru2RIU",
      authDomain: "tngon-b37d6.firebaseapp.com",
      databaseURL: "https://tngon-b37d6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tngon-b37d6",
      storageBucket: "tngon-b37d6.firebasestorage.app",
      messagingSenderId: "580319242104",
      appId: "1:580319242104:web:6922e4327bdc8286c30a8d",
      measurementId: "G-LHEH8ZC6SL"
    };
    let fbApp = null, rtdb = null, currentRef = null, currentBanListening = null, lastTs = 0;
    let serverOffsetMs = 0; // thêm để đồng bộ slideshow

    function connectFirebase() {
      if (!fbApp) fbApp = firebase.initializeApp(firebaseConfig);
      if (!rtdb) rtdb = firebase.database();
      // thêm: lấy lệch thời gian server để đồng bộ slideshow
      rtdb.ref(".
