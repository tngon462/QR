<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>T-NGON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* S·ª≠ d·ª•ng font Inter cho to√†n b·ªô trang */
    body {
      font-family: 'Inter', sans-serif;
      text-align: center;
      background-color: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    .main-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 1rem;
    }
    .screen {
        display: none;
        width: 100%;
        height: 100%;
    }
    #table-selection-screen {
        display: block;
    }
    .button-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      max-width: 600px;
      margin-top: 2rem;
    }
    .table-button {
      font-size: 2rem;
      font-weight: bold;
      padding: 2rem 1rem;
      background-color: #ffffff;
      color: #1f2937;
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .table-button:hover {
      background-color: #f3f4f6;
      border-color: #007aff;
      transform: translateY(-2px);
    }
    .start-button {
      font-size: 2.5rem;
      padding: 1.25rem 2.5rem;
      background-color: #007aff;
      color: white;
      border: none;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .start-button:hover {
      background-color: #005fbc;
      transform: translateY(-2px);
    }
    .start-button:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .iframe-container {
      width: 100%;
      height: 100vh;
      border: none;
      overflow: hidden;
    }
    .loading-indicator {
        font-size: 1.5rem;
        color: #6b7280;
        margin-top: 1rem;
    }
    .error-message {
        color: #ef4444;
        font-size: 1.2rem;
        margin-top: 1rem;
    }
    @media (max-width: 640px) {
      .button-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
      .table-button {
        font-size: 1.5rem;
        padding: 1.5rem 0.5rem;
      }
      .start-button {
        font-size: 2rem;
        padding: 1rem 2rem;
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="main-container" id="main-container">
    <!-- M√†n h√¨nh ch·ªçn b√†n -->
    <div class="screen" id="table-selection-screen">
      <h2 class="text-5xl font-bold text-gray-800">T-NGON</h2>
      <p class="text-lg text-gray-600 mt-2">Vui l√≤ng ch·ªçn b√†n c·ªßa b·∫°n</p>
      <div class="button-grid">
        <script>
            // T·∫°o 15 n√∫t b√†n t·ª± ƒë·ªông
            for (let i = 1; i <= 15; i++) {
                document.write(`<button class="table-button" onclick="selectTable(${i})">B√†n ${i}</button>`);
            }
        </script>
      </div>
    </div>
    
    <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu cho t·ª´ng b√†n -->
    <div class="screen" id="start-screen">
      <div class="space-y-4 text-gray-800">
        <h2 class="text-5xl font-bold">T-NGON</h2>
        <p class="text-lg">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫∑t m√≥n</p>
        <div class="button-container">
          <button class="start-button" onclick="startOrder()">üçΩÔ∏è B·∫ÆT ƒê·∫¶U</button>
        </div>
        <p id="table-info" class="text-sm text-gray-500 mt-4"></p>
        <button onclick="clearPage(true)" class="text-sm text-blue-500 underline mt-4">Quay l·∫°i m√†n h√¨nh ch·ªçn b√†n</button>
      </div>
    </div>
  </div>

  <script>
    let selectedBan = null;
    let checkInterval = null;

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.style.display = 'none';
      });
      document.getElementById(screenId).style.display = 'flex';
    }

    function selectTable(banNumber) {
      selectedBan = banNumber;
      document.getElementById('table-info').textContent = `B·∫°n ƒëang ·ªü B√†n ${selectedBan}`;
      showScreen('start-screen');
    }

    function startOrder() {
      if (!selectedBan) {
        showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin b√†n. Vui l√≤ng ch·ªçn l·∫°i.');
        return;
      }

      // ·∫®n m√†n h√¨nh b·∫Øt ƒë·∫ßu v√† hi·ªÉn th·ªã loading
      const startScreen = document.getElementById('start-screen');
      startScreen.style.display = 'none';
      
      const loadingMessage = document.createElement('div');
      loadingMessage.className = 'loading-indicator';
      loadingMessage.textContent = 'ƒêang t·∫£i trang g·ªçi m√≥n...';
      document.getElementById('main-container').appendChild(loadingMessage);

      // T·∫£i links.json v√† t·∫°o iframe
      fetch('links.json')
        .then(r => {
          if (!r.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i links.json');
          return r.json();
        })
        .then(data => {
          const url = data[selectedBan];
          if (url) {
            loadingMessage.remove(); // X√≥a loading message
            createIframe(url);
          } else {
            loadingMessage.remove();
            showError('Kh√¥ng t√¨m th·∫•y link cho b√†n ' + selectedBan);
            showScreen('start-screen'); // Quay l·∫°i m√†n h√¨nh b·∫Øt ƒë·∫ßu c·ªßa b√†n
          }
        })
        .catch(err => {
          loadingMessage.remove();
          showError('L·ªói t·∫£i file links.json: ' + err.message);
          showScreen('start-screen'); // Quay l·∫°i m√†n h√¨nh b·∫Øt ƒë·∫ßu c·ªßa b√†n
        });
    }

    function createIframe(url) {
      const iframe = document.createElement('iframe');
      iframe.id = 'pos-iframe';
      iframe.className = 'iframe-container';
      iframe.src = url;
      document.body.appendChild(iframe);

      // B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i h·∫øt h·∫°n trong iframe
      checkInterval = setInterval(() => {
        checkIframeContent(iframe);
      }, 5000); // Ki·ªÉm tra m·ªói 5 gi√¢y
    }
    
    function checkIframeContent(iframe) {
        try {
            // L·∫•y n·ªôi dung c·ªßa iframe. C·∫©n th·∫≠n v·ªõi l·ªói Cross-Origin.
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (iframeDoc) {
                const bodyText = iframeDoc.body.textContent.toLowerCase();
                
                // Ki·ªÉm tra c√°c t·ª´ kh√≥a h·∫øt h·∫°n trong n·ªôi dung trang
                if (bodyText.includes('h·∫øt h·∫°n') || bodyText.includes('h·∫øt hi·ªáu l·ª±c') || bodyText.includes('l·ªói')) {
                    console.log('Ph√°t hi·ªán trang h·∫øt h·∫°n. Quay l·∫°i m√†n h√¨nh b·∫Øt ƒë·∫ßu.');
                    clearPage(false); // Quay l·∫°i m√†n h√¨nh b·∫Øt ƒë·∫ßu c·ªßa b√†n
                }
            }
        } catch (e) {
            // L·ªói Cross-Origin. N·∫øu kh√¥ng th·ªÉ truy c·∫≠p n·ªôi dung, ta kh√¥ng th·ªÉ ki·ªÉm tra.
            console.log('Kh√¥ng th·ªÉ truy c·∫≠p n·ªôi dung iframe do l·ªói Cross-Origin.');
        }
    }

    function clearPage(goToTableSelection) {
      // D·ª´ng v√≤ng l·∫∑p ki·ªÉm tra
      if (checkInterval) {
        clearInterval(checkInterval);
      }

      // X√≥a iframe hi·ªán t·∫°i
      const iframe = document.getElementById('pos-iframe');
      if (iframe) {
        iframe.remove();
      }

      // Hi·ªÉn th·ªã l·∫°i m√†n h√¨nh ph√π h·ª£p
      if (goToTableSelection) {
        selectedBan = null;
        showScreen('table-selection-screen');
      } else {
        showScreen('start-screen');
      }
    }

    function showError(message) {
      const existingError = document.querySelector('.error-message');
      if (existingError) existingError.remove();
      
      const errorMessage = document.createElement('div');
      errorMessage.className = 'error-message';
      errorMessage.textContent = message;
      document.getElementById('main-container').appendChild(errorMessage);
      setTimeout(() => errorMessage.remove(), 5000);
    }
  </script>
</body>
</html>
