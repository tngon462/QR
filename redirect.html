<script>
  // ======= AUTO-SELECT BÀN từ query hoặc từ URL của iframe =======
  // Lấy query param
  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  // Khi DOM sẵn sàng: nếu có ?ban=... thì tự chọn + tự start
  document.addEventListener('DOMContentLoaded', () => {
    const qBan = getQueryParam('ban');
    if (qBan) {
      // Lưu ý: phần selectTable/startOrder được định nghĩa ở script dưới (nó sẽ có sau DOMContentLoaded)
      // nên ta đợi 1 tick cho chắc.
      setTimeout(() => {
        if (typeof selectTable === 'function') {
          selectTable(parseInt(qBan, 10));
          if (typeof startOrder === 'function') startOrder();
        }
      }, 100);
    }
  });

  // Nếu vì lý do gì selectedBan vẫn null nhưng iframe đã có src,
  // ta sẽ map ngược src -> số bàn dựa vào links.json và tự set selectedBan.
  async function backfillSelectedBanFromIframe() {
    try {
      if (window.selectedBan) return;
      const iframe = document.getElementById('pos-iframe');
      if (!iframe || !iframe.src) return;
      const r = await fetch("https://tngon462.github.io/QR/links.json");
      const data = await r.json();
      for (const [ban, url] of Object.entries(data)) {
        if (iframe.src === url) {
          window.selectedBan = parseInt(ban, 10);
          console.log('[AutoDetect] Gán selectedBan =', window.selectedBan, 'từ iframe.src');
          break;
        }
      }
    } catch(e) {
      console.warn('[AutoDetect] Không map được selectedBan từ iframe:', e);
    }
  }

  // Gọi định kỳ phòng khi selectedBan bị mất
  setInterval(backfillSelectedBanFromIframe, 1000);
  // ======= END AUTO-SELECT =======
</script>
